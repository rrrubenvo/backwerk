const SPREADSHEET_ID = '1LRSiRl-mZk-UeCGHSirCVces1DyCr3iDYENo0AEARRA';
const STATUS_SHEET_NAME = 'current stock status';
const PRODUCTS_SHEET_NAME = 'products';
const WRITEOFF_SHEET_NAME = 'write-offs';

function doGet(e) {
  var ss = SpreadsheetApp.openById(SPREADSHEET_ID);

  var statusSheet = ss.getSheetByName(STATUS_SHEET_NAME);
  var statusValues = statusSheet.getDataRange().getValues();

  var productsSheet = ss.getSheetByName(PRODUCTS_SHEET_NAME);
  var productsValues = productsSheet.getDataRange().getValues();

  var writeOffSheet = ss.getSheetByName(WRITEOFF_SHEET_NAME);
  var writeOffValues = writeOffSheet.getDataRange().getDisplayValues();

  var payload = {
    values: statusValues,
    products: productsValues,
    writeOffs: writeOffValues
  };

  return ContentService
    .createTextOutput(JSON.stringify(payload))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  if (!e.postData || !e.postData.contents) {
    return ContentService.createTextOutput('NO_DATA');
  }

  var data = JSON.parse(e.postData.contents);
  var ss = SpreadsheetApp.openById(SPREADSHEET_ID);

  if (data.values && data.values.length && data.values[0].length) {
    var statusSheet = ss.getSheetByName(STATUS_SHEET_NAME);
    statusSheet.clearContents();
    statusSheet
      .getRange(1, 1, data.values.length, data.values[0].length)
      .setValues(data.values);
  }

  if (data.writeOffs && data.writeOffs.length) {
    var writeOffSheet = ss.getSheetByName(WRITEOFF_SHEET_NAME);
    var tz = 'Europe/Amsterdam';
    var rows = [];
    for (var i = 0; i < data.writeOffs.length; i += 1) {
      var w = data.writeOffs[i];
      var now = new Date();
      var dateStr = Utilities.formatDate(now, tz, 'dd-MM-yyyy');
      var timeStr = Utilities.formatDate(now, tz, 'HH:mm');
      rows.push([
        dateStr,
        timeStr,
        w.productId,
        w.productTitle,
        w.amount
      ]);
    }
    if (rows.length) {
      writeOffSheet
        .getRange(writeOffSheet.getLastRow() + 1, 1, rows.length, rows[0].length)
        .setValues(rows);
    }
  }

  return ContentService.createTextOutput('OK');
}
