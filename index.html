<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Back-werk stock system</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    body {
      display: flex;
      flex-direction: column;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   sans-serif;
      background: #f5f5f5;
      overflow-y: auto;
    }

    .header {
      background: #ffffff;
      padding: 12px 24px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 1;
    }

    .logo svg {
      display: block;
      height: 32px;
    }

    .header-buttons {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-button {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid #000000;
      background: #ffffff;
      cursor: pointer;
      font-size: 0.85rem;
      user-select: none;
    }

    .header-button:hover {
      background: #f0f0f0;
    }

    .main {
      flex: 1;
      padding: 15px;
      box-sizing: border-box;
      position: relative;
      z-index: 0;
      overflow-y: auto;
    }

    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      width: 100%;
      height: auto;
      box-sizing: border-box;
    }

    .cell {
      box-sizing: border-box;
      flex: 0 0 calc((100% - 5 * 15px) / 6);
      height: auto;
      border-radius: 10px;
      position: relative;
      background: #e0e0e0;
      transition: background 150ms ease-out, box-shadow 150ms ease-out, transform 150ms ease-out;
      cursor: default;
      overflow: hidden;
    }

    .cell:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.16);
    }

    .cell.grey {
      background: #e0e0e0;
    }

    .cell.green {
      background: #c8e6c9;
    }

    .cell.orange {
      background: #ffe0b2;
    }

    .cell.red {
      background: #ffcdd2;
    }

    .location {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
      font-weight: 600;
      font-size: 0.8rem;
      color: #000000;
      letter-spacing: 0.03em;
    }

    .cell-meta {
      position: absolute;
      left: 8px;
      right: 8px;
      bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 0.75rem;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      padding: 4px 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.18);
    }

    .cell-product,
    .cell-amount {
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #111111;
    }

    .cell-product {
      font-weight: 600;
    }

    .cell-time-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .cell-time {
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #111111;
    }

    .cell-clear {
      font-size: 0.9rem;
      cursor: pointer;
      user-select: none;
      padding: 3px 6px;
      border-radius: 4px;
    }

    .cell-clear:hover {
      background: rgba(0, 0, 0, 0.06);
    }

    .cell-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .cell-stock-input {
      flex: 1;
      box-sizing: border-box;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #cccccc;
      font-size: 0.75rem;
      text-align: center;
    }

    .cell-add-button {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #000000;
      background: #ffffff;
      cursor: pointer;
      font-size: 0.75rem;
      user-select: none;
    }

    .cell-add-button:hover {
      background: #f0f0f0;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      z-index: 10;
    }

    .overlay.active {
      display: block;
    }

    .popup {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 11;
    }

    .popup.active {
      display: flex;
    }

    .popup-panel {
      background: #ffffff;
      border-radius: 14px;
      max-width: 960px;
      width: 90%;
      max-height: 80vh;
      padding: 16px 20px 20px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.35);
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }

    .writeoff-panel {
      max-width: 480px;
      width: min(90%, 480px);
    }

    .writeoff-list-panel {
      max-width: 720px;
      width: min(95%, 720px);
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    #writeoff-content {
      text-align: center;
    }

    #writeoff-list-content {
      font-size: 0.85rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .popup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .popup-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .popup-close {
      font-size: 1.2rem;
      cursor: pointer;
      user-select: none;
      padding: 4px 8px;
      border-radius: 999px;
    }

    .popup-close:hover {
      background: #f0f0f0;
    }

    .writeoff-list-filters {
      margin-bottom: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
    }

    #writeoff-date-input {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #cccccc;
      font-size: 0.85rem;
    }

    #writeoff-list-table-wrapper {
      flex: 1;
      overflow-y: auto;
    }

    .writeoff-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .writeoff-table th,
    .writeoff-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #eeeeee;
      text-align: left;
    }

    .writeoff-empty {
      font-size: 0.85rem;
      text-align: center;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 124.72 22.68">
        <defs>
          <style>.a{fill:#000000;}</style>
        </defs>
        <title>BackWerk Logo</title>
        <path class="a" d="M306.9,303.79q0,1.65,1.74,1.65h.43q1.74,0,1.74-1.65v-3.27A.79.79,0,0,1,311,300l.91-1c.11-.13.19-.19.25-.19s.12.07.21.21l3.51,5.22a3.54,3.54,0,0,0,.83.85,1.93,1.93,0,0,0,1.15.32h1.59a1.31,1.31,0,0,0,1-.29.9.9,0,0,0,.29-.67,1.3,1.3,0,0,0-.24-.69L315.07,296a.37.37,0,0,1-.08-.21.26.26,0,0,1,.11-.19l5.14-5.72a1.35,1.35,0,0,0,.43-.91.84.84,0,0,0-.31-.67,1.21,1.21,0,0,0-.84-.27H318a1.88,1.88,0,0,0-1.14.33,7.21,7.21,0,0,0-.9.87l-4.79,5.49q-.17.18-.24.18c-.08,0-.11-.07-.11-.21v-5c0-1.11-.58-1.66-1.74-1.66h-.43c-1.16,0-1.74.55-1.74,1.66Z" transform="translate(-196 -285.32)"></path>
        <path class="a" d="M299.9,293.64a3.22,3.22,0,0,1-.19,1.22,1.65,1.65,0,0,1-.55.73,2.17,2.17,0,0,1-.87.34,6.08,6.08,0,0,1-1.19.1H296a.27.27,0,0,1-.3-.3v-4.18a.27.27,0,0,1,.3-.3h1.15a6.08,6.08,0,0,1,1.19.1,2.06,2.06,0,0,1,.87.36,1.68,1.68,0,0,1,.55.74,3.12,3.12,0,0,1,.19,1.19m1.5,5.15a.84.84,0,0,1-.08-.21.11.11,0,0,1,.06-.11.35.35,0,0,0,.1-.08c1.63-.89,2.45-2.48,2.45-4.75a5.58,5.58,0,0,0-1.46-4.18A6.26,6.26,0,0,0,298,288h-4.73a1.44,1.44,0,0,0-1.07.41,1.42,1.42,0,0,0-.41,1.07v14.24c0,1.12.59,1.67,1.75,1.67h.4c1.17,0,1.75-.55,1.75-1.67v-4.21a.26.26,0,0,1,.3-.29h.78l.26,0h.27a.44.44,0,0,1,.41.24l2.6,4.67a3.44,3.44,0,0,0,.73.94,1.65,1.65,0,0,0,1.1.35h1.43a1.12,1.12,0,0,0,.84-.28.94.94,0,0,0,.29-.69,1.33,1.33,0,0,0-.22-.67Z" transform="translate(-196 -285.32)"></path>
        <path class="a" d="M278,303.94a1.39,1.39,0,0,0,1.49,1.48h9a1.22,1.22,0,0,0,1.35-1.4v-.38c0-1-.45-1.48-1.35-1.48h-6.28q-.3,0-.3-.27V298.5a.26.26,0,0,1,.3-.29h3.45a1.22,1.22,0,0,0,1.35-1.4v-.38c0-.95-.45-1.43-1.35-1.43h-3.45c-.2,0-.3-.09-.3-.29v-3.12a.27.27,0,0,1,.3-.3h5.9a1.22,1.22,0,0,0,1.35-1.4v-.4c0-1-.45-1.46-1.35-1.46h-8.65a1.41,1.41,0,0,0-1.49,1.48Z" transform="translate(-196 -285.32)"></path>
        <path class="a" d="M257.39,304.17a1.68,1.68,0,0,0,.57.89,1.72,1.72,0,0,0,1.13.36h1.41a1.63,1.63,0,0,0,1.68-1.25l2.59-9.41c.05-.21.1-.32.15-.32s.11.11.17.32l2.66,9.36a1.69,1.69,0,0,0,1.73,1.3H271a1.67,1.67,0,0,0,1.13-.36,1.85,1.85,0,0,0,.57-.94l3.89-14.33a3.11,3.11,0,0,0,.08-.64,1.25,1.25,0,0,0-.25-.8,1,1,0,0,0-.84-.32h-1.23a1.42,1.42,0,0,0-1.05.36,2.14,2.14,0,0,0-.52,1l-2.48,9.92c0,.18-.07.27-.13.27s-.13-.09-.19-.27l-2.85-10.1a1.42,1.42,0,0,0-.53-.82,1.39,1.39,0,0,0-.93-.32h-1.28a1.29,1.29,0,0,0-.9.32,1.56,1.56,0,0,0-.51.82l-2.82,10.1c-.06.18-.1.27-.14.27s-.12-.09-.16-.27l-2.47-9.89a2.18,2.18,0,0,0-.52-1,1.39,1.39,0,0,0-1.05-.38h-1.34a1,1,0,0,0-.88.34,1.29,1.29,0,0,0-.26.81,2,2,0,0,0,.1.63Z" transform="translate(-196 -285.32)"></path>
        <path class="a" d="M206.58,300.8a14.72,14.72,0,0,0,.08-1.58,16.23,16.23,0,0,0-.08-1.69,3.1,3.1,0,0,0-.35-1.18,1.48,1.48,0,0,0-.71-.67,2.85,2.85,0,0,0-1.19-.21,2.08,2.08,0,0,0-.85.17,2.33,2.33,0,0,0-.69.44,1,1,0,0,0-.18.17.56.56,0,0,0-.05.27v5.72a.42.42,0,0,0,.25.37,2.14,2.14,0,0,0,.76.27,5.15,5.15,0,0,0,.86.07,2.25,2.25,0,0,0,1.13-.25,1.72,1.72,0,0,0,.69-.72,3.67,3.67,0,0,0,.33-1.18m11.88,1.3v-2c0-.11-.05-.17-.13-.17a2.26,2.26,0,0,0-.39.07l-.81.17a4,4,0,0,0-1.41.53,1.21,1.21,0,0,0-.48,1.07,1.05,1.05,0,0,0,.41.95,1.74,1.74,0,0,0,1,.27,2.54,2.54,0,0,0,.88-.14,3.13,3.13,0,0,0,.71-.35.41.41,0,0,0,.23-.39m28.92,2.46a.83.83,0,0,1-.26.6,1.09,1.09,0,0,1-.76.25h-1.24a1.92,1.92,0,0,1-1-.25,2.22,2.22,0,0,1-.67-.72l-2.43-4.1c-.07-.1-.13-.15-.2-.15a.77.77,0,0,0-.32.07l-.4.15a.31.31,0,0,0-.2.32v3.19a1.42,1.42,0,0,1-.4,1.14,1.72,1.72,0,0,1-1.17.35H238a1.67,1.67,0,0,1-1.14-.35,1.42,1.42,0,0,1-.4-1.14V289.35a1.42,1.42,0,0,1,.4-1.14,1.72,1.72,0,0,1,1.17-.35h.34a1.72,1.72,0,0,1,1.17.35,1.42,1.42,0,0,1,.4,1.14v7.93c0,.13,0,.2.15.2a.69.69,0,0,0,.27-.1l.5-.22a1,1,0,0,0,.42-.35l2-2.83a3,3,0,0,1,.66-.73,1.62,1.62,0,0,1,1-.24h1.24a.89.89,0,0,1,.61.21.7.7,0,0,1,.23.53,1.28,1.28,0,0,1-.27.75l-2.73,3.75a.46.46,0,0,0-.08.25.91.91,0,0,0,.05.22l3.33,5.32a1.09,1.09,0,0,1,.15.52m-13.57-.69a1,1,0,0,1-.76,1,6.43,6.43,0,0,1-2.8.59,7.63,7.63,0,0,1-2.05-.29,4.4,4.4,0,0,1-1.84-1,5.08,5.08,0,0,1-1.32-2,8.46,8.46,0,0,1-.5-3.12,7.86,7.86,0,0,1,.5-3,5.54,5.54,0,0,1,1.32-2,4.84,4.84,0,0,1,1.84-1.08,6.66,6.66,0,0,1,2.05-.33,6.82,6.82,0,0,1,2.46.39,1.66,1.66,0,0,1,.58.37.74.74,0,0,1,.23.54,2.21,2.21,0,0,1,0,.35,3.5,3.5,0,0,1-.16.53,1.13,1.13,0,0,1-.33.59.81.81,0,0,1-.55.17,1,1,0,0,1-.36-.05l-.37-.11c-.13,0-.3-.07-.5-.11a5.05,5.05,0,0,0-.76-.05,3.44,3.44,0,0,0-1.07.16,1.69,1.69,0,0,0-.76.57,2.83,2.83,0,0,0-.46,1.13,8.52,8.52,0,0,0-.16,1.85,8.72,8.72,0,0,0,.16,1.87,2.63,2.63,0,0,0,.48,1.13,1.6,1.6,0,0,0,.78.56,3.15,3.15,0,0,0,1.06.16,5,5,0,0,0,.83-.06,3.61,3.61,0,0,0,.59-.15l.43-.14a1.25,1.25,0,0,1,.4-.06.88.88,0,0,1,.88.68,2.39,2.39,0,0,1,.16.48,1.15,1.15,0,0,1,0,.31m-11.73.32a1.05,1.05,0,0,1-.28.76,1.3,1.3,0,0,1-.84.34l-.52,0-.44,0a1.19,1.19,0,0,1-.71-.19,1,1,0,0,1-.37-.49c0-.14-.06-.24-.07-.31s0-.11-.08-.11a.21.21,0,0,0-.14.07,4,4,0,0,1-1.27.8,4.64,4.64,0,0,1-1.75.31,4.47,4.47,0,0,1-1.4-.21,3,3,0,0,1-1.1-.64,3.1,3.1,0,0,1-.74-1.08,4,4,0,0,1-.27-1.56,3.66,3.66,0,0,1,.31-1.53,3.19,3.19,0,0,1,.86-1.1,4.88,4.88,0,0,1,1.31-.75,11.78,11.78,0,0,1,1.67-.49l2-.42a.28.28,0,0,0,.25-.29V297a1.35,1.35,0,0,0-.57-1.31,3.35,3.35,0,0,0-1.62-.31,4.68,4.68,0,0,0-1,.12c-.35.08-.71.18-1.07.3a1.53,1.53,0,0,1-.41.07c-.44,0-.74-.29-.88-.86a2,2,0,0,1-.1-.45,2.11,2.11,0,0,1,0-.31,1,1,0,0,1,.21-.59,1.18,1.18,0,0,1,.63-.39,10.52,10.52,0,0,1,1.74-.4,11.91,11.91,0,0,1,1.76-.14,5.83,5.83,0,0,1,3.62.93,3.7,3.7,0,0,1,1.19,3.09v5.52c0,.29,0,.53,0,.72s0,.35.06.48.05.25.08.35a1.87,1.87,0,0,1,0,.34m-12-5.17q0,6.47-5.76,6.46a5.45,5.45,0,0,1-1.3-.16,3.7,3.7,0,0,1-1-.43.4.4,0,0,0-.17-.08s-.1.08-.17.22a.5.5,0,0,1-.34.32,2.32,2.32,0,0,1-.66.08h-.25c-.87,0-1.3-.48-1.3-1.45V289.35a1.45,1.45,0,0,1,.39-1.13,1.76,1.76,0,0,1,1.16-.34H201a1.69,1.69,0,0,1,1.13.34,1.45,1.45,0,0,1,.39,1.13v4.38c0,.08,0,.12.1.12s.11,0,.18-.12a2.51,2.51,0,0,1,1-.67,3.71,3.71,0,0,1,1.34-.24,5.84,5.84,0,0,1,2.05.34,3.88,3.88,0,0,1,1.57,1.09,5.1,5.1,0,0,1,1,1.93,10.18,10.18,0,0,1,.34,2.84m40.32,6V288.35a3,3,0,0,0-3-3H199a3,3,0,0,0-3,3V305a3,3,0,0,0,3,3h48.39a3,3,0,0,0,3-3" transform="translate(-196 -285.32)"></path>
      </svg>
    </div>
    <div class="header-buttons">
      <div id="writeoff-list-button" class="header-button">afschrijvingen</div>
    </div>
  </header>

  <main class="main">
    <div id="grid" class="grid"></div>
  </main>

  <div id="overlay" class="overlay"></div>

  <div id="writeoff-popup" class="popup">
    <div class="popup-panel writeoff-panel">
      <div class="popup-header">
        <div id="writeoff-title" class="popup-title"></div>
        <div id="writeoff-close" class="popup-close">Ã—</div>
      </div>
      <div id="writeoff-content"></div>
    </div>
  </div>

  <div id="writeoff-list-popup" class="popup">
    <div class="popup-panel writeoff-list-panel">
      <div class="popup-header">
        <div class="popup-title">Afschrijvingen</div>
        <div id="writeoff-list-close" class="popup-close">Ã—</div>
      </div>
      <div id="writeoff-list-content">
        <div class="writeoff-list-filters">
          <label>
            Datum:
            <input type="date" id="writeoff-date-input">
          </label>
        </div>
        <div id="writeoff-list-table-wrapper"></div>
      </div>
    </div>
  </div>

  <script>
    const COLS = 6;
    const ROWS = 5;
    const TOTAL_CELLS = ROWS * COLS;
    const COLOR_CLASSES = ['grey', 'green', 'orange', 'red'];
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxGVZusGYvG-9b3mLz7UxSZJooAUa4Tdypofp_XUl6bLsmKurfmE6ZwHH9RfErxBRncog/exec';

    const grid = document.getElementById('grid');
    const baseCharCode = 'A'.charCodeAt(0);
    const overlay = document.getElementById('overlay');

    const writeoffPopup = document.getElementById('writeoff-popup');
    const writeoffClose = document.getElementById('writeoff-close');
    const writeoffTitle = document.getElementById('writeoff-title');
    const writeoffContent = document.getElementById('writeoff-content');

    const writeoffListPopup = document.getElementById('writeoff-list-popup');
    const writeoffListClose = document.getElementById('writeoff-list-close');
    const writeoffListButton = document.getElementById('writeoff-list-button');
    const writeoffDateInput = document.getElementById('writeoff-date-input');
    const writeoffListTableWrapper = document.getElementById('writeoff-list-table-wrapper');

    let tableRows = [];
    let statusMatrix = [];
    let products = [];
    let writeOffs = [];
    let syncTimeoutId = null;
    let observer = null;
    let elapsedTimerId = null;
    let writeoffCell = null;

    function indexFromRowCol(r, c) {
      return (r - 1) * COLS + (c - 1);
    }

    function createEmptyMatrix(rows, cols, value) {
      const matrix = [];
      for (let r = 0; r < rows; r += 1) {
        const row = [];
        for (let c = 0; c < cols; c += 1) {
          row.push(value);
        }
        matrix.push(row);
      }
      return matrix;
    }

    function buildTableFromValues(values) {
      const header = ['location', 'class', 'product', 'amount', 'start_time'];
      const rows = [];
      rows.push(header);

      for (let r = 1; r <= ROWS; r += 1) {
        for (let c = 1; c <= COLS; c += 1) {
          const idx = indexFromRowCol(r, c);
          const srcRow = values && values[idx + 1] ? values[idx + 1] : [];
          const canonicalLoc = String.fromCharCode(baseCharCode + c - 1) + r;

          let loc = srcRow[0];
          if (!loc || String(loc).trim() === '') {
            loc = canonicalLoc;
          }

          let color = srcRow[1];
          if (!color || COLOR_CLASSES.indexOf(String(color)) === -1) {
            color = 'grey';
          }

          let product = srcRow[2] || '';
          let amount = srcRow[3] || '';
          let startTime = srcRow[4] || '';

          rows.push([loc, color, product, amount, startTime]);
        }
      }
      return rows;
    }

    function tableToStatusMatrix(rows) {
      const matrix = createEmptyMatrix(ROWS, COLS, 'grey');
      for (let r = 1; r <= ROWS; r += 1) {
        for (let c = 1; c <= COLS; c += 1) {
          const idx = indexFromRowCol(r, c) + 1;
          const row = rows[idx];
          const color = row && row[1] ? row[1] : 'grey';
          matrix[r - 1][c - 1] = COLOR_CLASSES.indexOf(color) === -1 ? 'grey' : color;
        }
      }
      return matrix;
    }

    function buildProductsFromValues(rows) {
      const list = [];
      if (!rows) {
        return list;
      }
      for (let i = 0; i < rows.length; i += 1) {
        const row = rows[i] || [];
        const id = row[0];
        const title = row[1];
        if (!id || !title) {
          continue;
        }
        list.push({
          id: String(id).trim(),
          title: String(title).trim()
        });
      }
      return list;
    }

    function buildWriteOffsFromValues(rows) {
      const list = [];
      if (!rows) {
        return list;
      }
      for (let i = 0; i < rows.length; i += 1) {
        const row = rows[i] || [];
        const date = row[0] ? String(row[0]) : '';
        const time = row[1] ? String(row[1]) : '';
        const productId = row[2] ? String(row[2]) : '';
        const productTitle = row[3] ? String(row[3]) : '';
        const amount = row[4] ? String(row[4]) : '';
        if (!date && !time && !productId && !productTitle && !amount) {
          continue;
        }
        list.push({
          date: date,
          time: time,
          productId: productId,
          productTitle: productTitle,
          amount: amount
        });
      }
      return list;
    }

    function computeElapsedMinutes(startEpoch) {
      const base = Number(startEpoch);
      if (!base || base <= 0) {
        return 0;
      }
      const diffMs = Date.now() - base;
      if (diffMs <= 0) {
        return 0;
      }
      const minutes = Math.floor(diffMs / 60000);
      return minutes;
    }

    function computeElapsedLabel(startEpoch) {
      const minutes = computeElapsedMinutes(startEpoch);
      return String(minutes) + ' min';
    }

    function getProductTitleById(productId) {
      const idStr = String(productId);
      for (let i = 0; i < products.length; i += 1) {
        if (products[i].id === idStr) {
          return products[i].title;
        }
      }
      return '';
    }

    function formatProductDisplay(productId) {
      if (!productId) {
        return '';
      }
      const idStr = String(productId);
      const title = getProductTitleById(idStr);
      if (title) {
        return idStr + ' - ' + title;
      }
      return idStr;
    }

    function getDisplayCols() {
      const width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth || 0;
      let cols = Math.floor(width / 300);
      if (cols < 1) {
        cols = 1;
      }
      return cols;
    }

    function buildGridFromMatrix(matrix) {
      const displayCols = getDisplayCols();

      grid.innerHTML = '';
      for (let r = 1; r <= ROWS; r += 1) {
        for (let c = 1; c <= COLS; c += 1) {
          const cell = document.createElement('div');
          cell.classList.add('cell', 'row-' + r, 'col-' + c);
          cell.dataset.row = String(r);
          cell.dataset.col = String(c);

          cell.style.flex = '0 0 calc((100% - ' + (displayCols - 1) + ' * 15px) / ' + displayCols + ')';

          const color = matrix[r - 1][c - 1];
          if (COLOR_CLASSES.indexOf(color) === -1) {
            cell.classList.add('grey');
          } else {
            cell.classList.add(color);
          }

          const tableIndex = indexFromRowCol(r, c) + 1;
          const tRow = tableRows[tableIndex] || [];
          let productId = tRow[2] ? String(tRow[2]) : '';
          const cellIndex0 = indexFromRowCol(r, c);

          if (!productId && products && products[cellIndex0]) {
            productId = products[cellIndex0].id;
            tRow[2] = productId;
            tableRows[tableIndex] = tRow;
          }

          const amount = tRow[3] ? String(tRow[3]) : '';
          const startEpochStr = tRow[4] ? String(tRow[4]) : '';
          const startEpoch = startEpochStr && !isNaN(Number(startEpochStr)) ? Number(startEpochStr) : null;

          if (productId) {
            cell.classList.add(productId);
          }
          if (amount) {
            cell.classList.add('amount_' + amount);
          }
          if (startEpoch !== null) {
            cell.classList.add('start_time_' + startEpochStr);
            cell.dataset.startEpoch = startEpochStr;
          }

          const location = document.createElement('div');
          location.classList.add('location');
          const productDisplay = productId ? formatProductDisplay(productId) : '';
          location.textContent = productDisplay;

          const meta = document.createElement('div');
          meta.classList.add('cell-meta');

          const productDiv = document.createElement('div');
          productDiv.classList.add('cell-product');
          productDiv.textContent = productDisplay;

          const amountDiv = document.createElement('div');
          amountDiv.classList.add('cell-amount');
          amountDiv.textContent = amount ? 'aantal: ' + amount : '';

          const timeRow = document.createElement('div');
          timeRow.classList.add('cell-time-row');

          const timeDiv = document.createElement('div');
          timeDiv.classList.add('cell-time');
          if (startEpoch !== null) {
            timeDiv.textContent = 'tijd op locatie: ' + computeElapsedLabel(startEpochStr);
          } else {
            timeDiv.textContent = '';
          }

          const clearDiv = document.createElement('div');
          clearDiv.classList.add('cell-clear');
          clearDiv.textContent = 'ðŸ—‘';
          clearDiv.addEventListener('click', function (ev) {
            ev.stopPropagation();
            openWriteoffConfirm(cell);
          });

          timeRow.appendChild(timeDiv);
          timeRow.appendChild(clearDiv);

          const controls = document.createElement('div');
          controls.classList.add('cell-controls');

          const stockInput = document.createElement('input');
          stockInput.type = 'number';
          stockInput.min = '1';
          stockInput.step = '1';
          stockInput.value = amount ? String(amount) : '1';
          stockInput.classList.add('cell-stock-input');
          stockInput.inputMode = 'numeric';
          stockInput.pattern = '[0-9]*';

          const addButton = document.createElement('button');
          addButton.type = 'button';
          addButton.classList.add('cell-add-button');
          addButton.textContent = 'toevoegen';

          addButton.addEventListener('click', function (ev) {
            ev.stopPropagation();
            handleAddStock(cell, stockInput);
          });

          controls.appendChild(stockInput);
          controls.appendChild(addButton);

          meta.appendChild(productDiv);
          meta.appendChild(amountDiv);
          meta.appendChild(timeRow);
          meta.appendChild(controls);

          cell.appendChild(location);
          cell.appendChild(meta);

          grid.appendChild(cell);
        }
      }
    }

    function getCellColorClass(element) {
      for (let i = 0; i < COLOR_CLASSES.length; i += 1) {
        const cls = COLOR_CLASSES[i];
        if (element.classList.contains(cls)) {
          return cls;
        }
      }
      return 'grey';
    }

    function scheduleSync() {
      if (syncTimeoutId !== null) {
        clearTimeout(syncTimeoutId);
      }
      syncTimeoutId = setTimeout(function () {
        syncTimeoutId = null;
        sendStatusToSheet();
      }, 500);
    }

    function startObserver() {
      observer = new MutationObserver(function (mutations) {
        let changed = false;
        for (let i = 0; i < mutations.length; i += 1) {
          const mutation = mutations[i];
          if (mutation.type !== 'attributes') {
            continue;
          }
          if (mutation.attributeName !== 'class') {
            continue;
          }
          const element = mutation.target;
          if (!element.dataset || !element.dataset.row || !element.dataset.col) {
            continue;
          }
          const rowIndex = parseInt(element.dataset.row, 10) - 1;
          const colIndex = parseInt(element.dataset.col, 10) - 1;
          if (rowIndex < 0 || colIndex < 0) {
            continue;
          }
          const color = getCellColorClass(element);
          if (statusMatrix[rowIndex][colIndex] !== color) {
            statusMatrix[rowIndex][colIndex] = color;
            const idx = indexFromRowCol(rowIndex + 1, colIndex + 1) + 1;
            if (tableRows[idx]) {
              tableRows[idx][1] = color;
            }
            changed = true;
          }
        }
        if (changed) {
          scheduleSync();
        }
      });

      observer.observe(grid, {
        attributes: true,
        attributeFilter: ['class'],
        subtree: true
      });
    }

    async function fetchSheetData() {
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'GET'
        });
        if (!response.ok) {
          return null;
        }
        const data = await response.json();
        return data;
      } catch (e) {
        return null;
      }
    }

    async function sendStatusToSheet() {
      try {
        const payload = { values: tableRows };
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8'
          },
          body: JSON.stringify(payload)
        });
      } catch (e) {
      }
    }

    async function sendWriteOff(productId, productTitle, amount) {
      try {
        const payload = {
          values: tableRows,
          writeOffs: [{
            productId: productId,
            productTitle: productTitle,
            amount: String(amount)
          }]
        };
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8'
          },
          body: JSON.stringify(payload)
        });
      } catch (e) {
      }
    }

    function openWriteoffConfirm(cell) {
      writeoffCell = cell;

      const locEl = cell.querySelector('.location');
      const locLabel = locEl ? locEl.textContent : '';

      writeoffTitle.textContent = 'Product afschrijven?';
      writeoffContent.innerHTML = '';

      const msg = document.createElement('div');
      msg.textContent = 'Product ' + locLabel;

      const buttons = document.createElement('div');
      buttons.style.display = 'flex';
      buttons.style.gap = '10px';
      buttons.style.marginTop = '14px';
      buttons.style.justifyContent = 'center';

      function makeButton(label) {
        const b = document.createElement('button');
        b.textContent = label;
        b.style.padding = '8px 18px';
        b.style.borderRadius = '999px';
        b.style.border = '1px solid #000000';
        b.style.background = '#ffffff';
        b.style.cursor = 'pointer';
        b.style.fontSize = '0.9rem';
        return b;
      }

      const btnJa = makeButton('ja');
      const btnNee = makeButton('nee');
      const btnAnnuleren = makeButton('annuleren');

      btnJa.addEventListener('click', function () {
        openWriteoffAmountStep();
      });

      btnNee.addEventListener('click', function () {
        clearLocation(cell);
        closeWriteoffPopup();
      });

      btnAnnuleren.addEventListener('click', function () {
        closeWriteoffPopup();
      });

      buttons.appendChild(btnJa);
      buttons.appendChild(btnNee);
      buttons.appendChild(btnAnnuleren);

      writeoffContent.appendChild(msg);
      writeoffContent.appendChild(buttons);

      overlay.classList.add('active');
      writeoffPopup.classList.add('active');
    }

    function openWriteoffAmountStep() {
      if (!writeoffCell) {
        closeWriteoffPopup();
        return;
      }
      const rowIndex = parseInt(writeoffCell.dataset.row, 10);
      const colIndex = parseInt(writeoffCell.dataset.col, 10);
      const tableIndex = indexFromRowCol(rowIndex, colIndex) + 1;
      const record = tableRows[tableIndex];
      if (!record) {
        closeWriteoffPopup();
        return;
      }

      const productId = record[2] ? String(record[2]) : '';
      const amountStr = record[3] ? String(record[3]) : '';
      let maxAmount = parseInt(amountStr, 10);
      if (!maxAmount || maxAmount < 1) {
        maxAmount = 1;
      }

      const productDisplay = formatProductDisplay(productId);
      const productTitle = getProductTitleById(productId);

      writeoffTitle.textContent = 'Product afschrijven';
      writeoffContent.innerHTML = '';

      const info = document.createElement('div');
      info.innerHTML = 'Product <strong>' + productDisplay + '</strong>';

      const amountWrap = document.createElement('div');
      amountWrap.style.marginTop = '10px';

      const amountLabel = document.createElement('div');
      amountLabel.textContent = 'Aantal af te schrijven (max ' + String(maxAmount) + '):';

      const amountInput = document.createElement('input');
      amountInput.id = 'writeoff-amount-input';
      amountInput.type = 'number';
      amountInput.min = '1';
      amountInput.max = String(maxAmount);
      amountInput.step = '1';
      amountInput.value = String(maxAmount);
      amountInput.style.marginTop = '6px';
      amountInput.style.width = '100px';
      amountInput.style.padding = '6px 8px';
      amountInput.style.borderRadius = '6px';
      amountInput.style.border = '1px solid #cccccc';
      amountInput.style.textAlign = 'center';
      amountInput.inputMode = 'numeric';
      amountInput.pattern = '[0-9]*';

      amountWrap.appendChild(amountLabel);
      amountWrap.appendChild(amountInput);

      const buttons = document.createElement('div');
      buttons.style.display = 'flex';
      buttons.style.gap = '10px';
      buttons.style.marginTop = '14px';
      buttons.style.justifyContent = 'center';

      function makeButton(label, filled) {
        const b = document.createElement('button');
        b.textContent = label;
        b.style.padding = '8px 18px';
        b.style.borderRadius = '999px';
        b.style.cursor = 'pointer';
        b.style.fontSize = '0.9rem';
        if (filled) {
          b.style.background = '#000000';
          b.style.color = '#ffffff';
          b.style.border = '1px solid #000000';
        } else {
          b.style.background = '#ffffff';
          b.style.color = '#000000';
          b.style.border = '1px solid #000000';
        }
        return b;
      }

      const btnAfschrijven = makeButton('afschrijven', true);
      const btnAnnuleren = makeButton('annuleren', false);

      btnAfschrijven.addEventListener('click', function () {
        let selected = parseInt(amountInput.value, 10);
        if (!selected || selected < 1) {
          selected = 1;
        }
        if (selected > maxAmount) {
          selected = maxAmount;
        }
        handleWriteoffConfirm(productId, productTitle, selected);
      });

      btnAnnuleren.addEventListener('click', function () {
        closeWriteoffPopup();
      });

      buttons.appendChild(btnAfschrijven);
      buttons.appendChild(btnAnnuleren);

      writeoffContent.appendChild(info);
      writeoffContent.appendChild(amountWrap);
      writeoffContent.appendChild(buttons);
    }

    function closeWriteoffPopup() {
      writeoffPopup.classList.remove('active');
      writeoffContent.innerHTML = '';
      writeoffCell = null;
      const otherOpen = writeoffListPopup.classList.contains('active');
      if (!otherOpen) {
        overlay.classList.remove('active');
      }
    }

    function clearLocation(cell) {
      const row = parseInt(cell.dataset.row, 10);
      const col = parseInt(cell.dataset.col, 10);
      if (!row || !col) {
        return;
      }
      const tableIndex = indexFromRowCol(row, col) + 1;
      if (!tableRows[tableIndex]) {
        return;
      }

      const currentProductId = tableRows[tableIndex][2] ? String(tableRows[tableIndex][2]) : '';

      tableRows[tableIndex][1] = 'grey';
      tableRows[tableIndex][3] = '';
      tableRows[tableIndex][4] = '';

      cell.dataset.startEpoch = '';

      const existing = [];
      for (let i = 0; i < cell.classList.length; i += 1) {
        existing.push(cell.classList.item(i));
      }

      for (let i = 0; i < products.length; i += 1) {
        cell.classList.remove(products[i].id);
      }

      for (let i = 0; i < existing.length; i += 1) {
        const cls = existing[i];
        if (cls.indexOf('amount_') === 0 || cls.indexOf('start_time_') === 0) {
          cell.classList.remove(cls);
        }
      }

      for (let i = 0; i < COLOR_CLASSES.length; i += 1) {
        cell.classList.remove(COLOR_CLASSES[i]);
      }
      cell.classList.add('grey');

      const meta = cell.querySelector('.cell-meta');
      if (meta) {
        const productDiv = meta.querySelector('.cell-product');
        const amountDiv = meta.querySelector('.cell-amount');
        const timeDiv = meta.querySelector('.cell-time');
        if (productDiv) {
          productDiv.textContent = currentProductId ? formatProductDisplay(currentProductId) : '';
        }
        if (amountDiv) {
          amountDiv.textContent = '';
        }
        if (timeDiv) {
          timeDiv.textContent = '';
        }
      }

      const rowIndex = row - 1;
      const colIndex = col - 1;
      if (rowIndex >= 0 && colIndex >= 0 && rowIndex < ROWS && colIndex < COLS) {
        statusMatrix[rowIndex][colIndex] = 'grey';
      }

      scheduleSync();
    }

    function handleWriteoffConfirm(productId, productTitle, amount) {
      if (!writeoffCell) {
        closeWriteoffPopup();
        return;
      }
      clearLocation(writeoffCell);
      sendWriteOff(productId, productTitle, amount);
      closeWriteoffPopup();
      updateElapsedTimes();
    }

    function updateCellForSelection(cell, tableIndex, productId, amount, startEpochStr) {
      if (!tableRows[tableIndex]) {
        return;
      }

      tableRows[tableIndex][2] = productId;
      tableRows[tableIndex][3] = String(amount);
      tableRows[tableIndex][4] = startEpochStr;

      const existing = [];
      for (let i = 0; i < cell.classList.length; i += 1) {
        existing.push(cell.classList.item(i));
      }

      for (let i = 0; i < products.length; i += 1) {
        cell.classList.remove(products[i].id);
      }

      for (let i = 0; i < existing.length; i += 1) {
        const cls = existing[i];
        if (cls.indexOf('amount_') === 0 || cls.indexOf('start_time_') === 0) {
          cell.classList.remove(cls);
        }
      }

      for (let i = 0; i < COLOR_CLASSES.length; i += 1) {
        cell.classList.remove(COLOR_CLASSES[i]);
      }
      cell.classList.add('green');

      if (productId) {
        cell.classList.add(productId);
      }
      cell.classList.add('amount_' + String(amount));
      cell.classList.add('start_time_' + startEpochStr);
      cell.dataset.startEpoch = startEpochStr;

      const meta = cell.querySelector('.cell-meta');
      if (meta) {
        const productDiv = meta.querySelector('.cell-product');
        const amountDiv = meta.querySelector('.cell-amount');
        const timeDiv = meta.querySelector('.cell-time');
        const productDisplay = productId ? formatProductDisplay(productId) : '';
        if (productDiv) {
          productDiv.textContent = productDisplay;
        }
        if (amountDiv) {
          amountDiv.textContent = amount ? 'aantal: ' + String(amount) : '';
        }
        if (timeDiv) {
          timeDiv.textContent = 'tijd op locatie: ' + computeElapsedLabel(startEpochStr);
        }

        const header = cell.querySelector('.location');
        if (header) {
          header.textContent = productDisplay;
        }
      }
    }

    function handleAddStock(cell, inputElement) {
      const row = parseInt(cell.dataset.row, 10);
      const col = parseInt(cell.dataset.col, 10);
      if (!row || !col) {
        return;
      }
      const tableIndex = indexFromRowCol(row, col) + 1;
      const record = tableRows[tableIndex];
      if (!record) {
        return;
      }
      const productId = record[2] ? String(record[2]) : '';
      if (!productId) {
        return;
      }

      const raw = inputElement ? inputElement.value : '';
      let amount = parseInt(raw, 10);
      if (!amount || amount < 1) {
        amount = 1;
      }

      const now = Date.now();
      const startEpochStr = String(now);

      updateCellForSelection(cell, tableIndex, productId, amount, startEpochStr);
      scheduleSync();
      updateElapsedTimes();
    }

    function updateElapsedTimes() {
      const cells = grid.querySelectorAll('.cell');
      for (let i = 0; i < cells.length; i += 1) {
        const cell = cells[i];
        const startEpochStr = cell.dataset.startEpoch;
        if (!startEpochStr) {
          continue;
        }
        const meta = cell.querySelector('.cell-meta');
        if (!meta) {
          continue;
        }
        const timeDiv = meta.querySelector('.cell-time');
        if (!timeDiv) {
          continue;
        }

        const minutes = computeElapsedMinutes(startEpochStr);
        timeDiv.textContent = 'tijd op locatie: ' + String(minutes) + ' min';

        let newColor = 'green';
        if (minutes > 105 && minutes < 120) {
          newColor = 'orange';
        } else if (minutes >= 120) {
          newColor = 'red';
        }

        const currentColor = getCellColorClass(cell);
        if (currentColor !== newColor) {
          for (let j = 0; j < COLOR_CLASSES.length; j += 1) {
            cell.classList.remove(COLOR_CLASSES[j]);
          }
          cell.classList.add(newColor);
        }
      }
    }

    function getTodayDateString() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      const day = now.getDate();
      const mm = month < 10 ? '0' + month : String(month);
      const dd = day < 10 ? '0' + day : String(day);
      return year + '-' + mm + '-' + dd;
    }

    function sheetDateToInputFormat(sheetDateStr) {
      if (!sheetDateStr) {
        return '';
      }
      const s = String(sheetDateStr).trim();
      const parts = s.split('-');
      if (parts.length !== 3) {
        return '';
      }
      const d = parts[0];
      const m = parts[1];
      const y = parts[2];
      const dd = d.length === 1 ? '0' + d : d;
      const mm = m.length === 1 ? '0' + m : m;
      return y + '-' + mm + '-' + dd;
    }

    function renderWriteoffListForDate(inputDateStr) {
      if (!writeoffListTableWrapper) {
        return;
      }
      writeoffListTableWrapper.innerHTML = '';
      const targetDate = inputDateStr;
      const list = [];
      for (let i = 0; i < writeOffs.length; i += 1) {
        const w = writeOffs[i];
        const converted = sheetDateToInputFormat(w.date);
        if (converted === targetDate) {
          list.push(w);
        }
      }

      if (list.length === 0) {
        const empty = document.createElement('div');
        empty.classList.add('writeoff-empty');
        empty.textContent = 'Geen afschrijvingen voor deze datum.';
        writeoffListTableWrapper.appendChild(empty);
        return;
      }

      const table = document.createElement('table');
      table.classList.add('writeoff-table');

      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      const headers = ['Tijd', 'Product ID', 'Product', 'Aantal'];
      for (let i = 0; i < headers.length; i += 1) {
        const th = document.createElement('th');
        th.textContent = headers[i];
        headRow.appendChild(th);
      }
      thead.appendChild(headRow);

      const tbody = document.createElement('tbody');
      for (let i = 0; i < list.length; i += 1) {
        const w = list[i];
        const tr = document.createElement('tr');

        const tdTime = document.createElement('td');
        tdTime.textContent = w.time;

        const tdId = document.createElement('td');
        tdId.textContent = w.productId;

        const tdTitle = document.createElement('td');
        tdTitle.textContent = w.productTitle;

        const tdAmount = document.createElement('td');
        tdAmount.textContent = w.amount;

        tr.appendChild(tdTime);
        tr.appendChild(tdId);
        tr.appendChild(tdTitle);
        tr.appendChild(tdAmount);

        tbody.appendChild(tr);
      }

      table.appendChild(thead);
      table.appendChild(tbody);
      writeoffListTableWrapper.appendChild(table);
    }

    async function refreshWriteOffsFromSheet() {
      const sheetData = await fetchSheetData();
      if (!sheetData || !sheetData.writeOffs) {
        writeOffs = [];
        return;
      }
      const writeOffValues = sheetData.writeOffs;
      writeOffs = buildWriteOffsFromValues(writeOffValues);
    }

    function closeWriteoffListPopup() {
      writeoffListPopup.classList.remove('active');
      const otherOpen = writeoffPopup.classList.contains('active');
      if (!otherOpen) {
        overlay.classList.remove('active');
      }
    }

    async function init() {
      writeoffClose.addEventListener('click', function () {
        closeWriteoffPopup();
      });
      writeoffListClose.addEventListener('click', function () {
        closeWriteoffListPopup();
      });

      writeoffListButton.addEventListener('click', function () {
        const todayStr = getTodayDateString();
        writeoffDateInput.value = todayStr;

        writeoffListTableWrapper.innerHTML = '';
        const loading = document.createElement('div');
        loading.classList.add('writeoff-empty');
        loading.textContent = 'Laden...';
        writeoffListTableWrapper.appendChild(loading);

        overlay.classList.add('active');
        writeoffListPopup.classList.add('active');

        refreshWriteOffsFromSheet().then(function () {
          renderWriteoffListForDate(writeoffDateInput.value);
        });
      });

      writeoffDateInput.addEventListener('change', function () {
        renderWriteoffListForDate(writeoffDateInput.value);
      });

      overlay.addEventListener('click', function () {
        closeWriteoffPopup();
        closeWriteoffListPopup();
      });

      const sheetData = await fetchSheetData();
      const sheetValues = sheetData && sheetData.values ? sheetData.values : null;
      const productValues = sheetData && sheetData.products ? sheetData.products : null;
      const writeOffValues = sheetData && sheetData.writeOffs ? sheetData.writeOffs : null;

      tableRows = buildTableFromValues(sheetValues);
      products = buildProductsFromValues(productValues);
      writeOffs = buildWriteOffsFromValues(writeOffValues);
      statusMatrix = tableToStatusMatrix(tableRows);
      buildGridFromMatrix(statusMatrix);
      startObserver();
      sendStatusToSheet();
      updateElapsedTimes();
      elapsedTimerId = setInterval(updateElapsedTimes, 60000);

      window.addEventListener('resize', function () {
        buildGridFromMatrix(statusMatrix);
      });
    }

    init();
  </script>
</body>
</html>
