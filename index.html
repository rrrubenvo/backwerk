<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Back-werk stock system</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    body {
      display: flex;
      flex-direction: column;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   sans-serif;
      background: #f5f5f5;
      overflow-y: auto;
    }

    .header {
      background: #ffffff;
      padding: 12px 24px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 1;
    }

    .logo svg {
      display: block;
      height: 32px;
    }

    .header-buttons {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-button {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid #000000;
      background: #ffffff;
      cursor: pointer;
      font-size: 0.85rem;
      user-select: none;
    }

    .header-button:hover {
      background: #f0f0f0;
    }

    .main {
      flex: 1;
      padding: 15px;
      box-sizing: border-box;
      position: relative;
      z-index: 0;
      overflow-y: auto;
    }

    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      width: 100%;
      height: auto;
      box-sizing: border-box;
    }

    .cell {
      box-sizing: border-box;
      flex: 0 0 calc((100% - 5 * 15px) / 6);
      height: auto;
      min-height: 160px;
      border-radius: 10px;
      position: relative;
      background: #e0e0e0;
      transition: background 150ms ease-out, box-shadow 150ms ease-out, transform 150ms ease-out;
      cursor: default;
      overflow: hidden;
    }

    .cell:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.16);
    }

    .cell.grey {
      background: #e0e0e0;
    }

    .cell.green {
      background: #c8e6c9;
    }

    .cell.orange {
      background: #ffe0b2;
    }

    .cell.red {
      background: #ffcdd2;
    }

    .location {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
      font-weight: 600;
      font-size: 0.8rem;
      color: #000000;
      letter-spacing: 0.03em;
    }

    .cell-meta {
      position: absolute;
      left: 8px;
      right: 8px;
      bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 0.75rem;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      padding: 4px 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.18);
    }

    .cell-product,
    .cell-amount {
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #111111;
    }

    .cell-product {
      font-weight: 600;
    }

    .cell-time-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .cell-time {
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #111111;
    }

    .cell-clear {
      font-size: 0.9rem;
      cursor: pointer;
      user-select: none;
      padding: 3px 6px;
      border-radius: 4px;
    }

    .cell-clear:hover {
      background: rgba(0, 0, 0, 0.06);
    }

    .cell-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .cell-stock-input {
      flex: 1;
      box-sizing: border-box;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #cccccc;
      font-size: 0.75rem;
      text-align: center;
    }

    .cell-add-button {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #000000;
      background: #ffffff;
      cursor: pointer;
      font-size: 0.75rem;
      user-select: none;
    }

    .cell-add-button:hover {
      background: #f0f0f0;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      z-index: 10;
    }

    .overlay.active {
      display: block;
    }

    .popup {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 11;
    }

    .popup.active {
      display: flex;
    }

    .popup-panel {
      background: #ffffff;
      border-radius: 14px;
      max-width: 960px;
      width: 90%;
      max-height: 80vh;
      padding: 16px 20px 20px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.35);
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }

    .writeoff-panel {
      max-width: 480px;
      width: min(90%, 480px);
    }

    .writeoff-list-panel {
      max-width: 720px;
      width: min(95%, 720px);
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    #writeoff-content {
      text-align: center;
    }

    #writeoff-list-content {
      font-size: 0.85rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .popup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .popup-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .popup-close {
      font-size: 1.2rem;
      cursor: pointer;
      user-select: none;
      padding: 4px 8px;
      border-radius: 999px;
    }

    .popup-close:hover {
      background: #f0f0f0;
    }

    .writeoff-list-filters {
      margin-bottom: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
    }

    #writeoff-date-input {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #cccccc;
      font-size: 0.85rem;
    }

    #writeoff-list-table-wrapper {
      flex: 1;
      overflow-y: auto;
    }

    .writeoff-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .writeoff-table th,
    .writeoff-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #eeeeee;
      text-align: left;
    }

    .writeoff-empty {
      font-size: 0.85rem;
      text-align: center;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <!-- logo svg omitted for brevity (same as before) -->
    </div>
    <div class="header-buttons">
      <div id="writeoff-list-button" class="header-button">afschrijvingen</div>
    </div>
  </header>

  <main class="main">
    <div id="grid" class="grid"></div>
  </main>

  <div id="overlay" class="overlay"></div>

  <div id="writeoff-popup" class="popup">
    <div class="popup-panel writeoff-panel">
      <div class="popup-header">
        <div id="writeoff-title" class="popup-title"></div>
        <div id="writeoff-close" class="popup-close">Ã—</div>
      </div>
      <div id="writeoff-content"></div>
    </div>
  </div>

  <div id="writeoff-list-popup" class="popup">
    <div class="popup-panel writeoff-list-panel">
      <div class="popup-header">
        <div class="popup-title">Afschrijvingen</div>
        <div id="writeoff-list-close" class="popup-close">Ã—</div>
      </div>
      <div id="writeoff-list-content">
        <div class="writeoff-list-filters">
          <label>
            Datum:
            <input type="date" id="writeoff-date-input">
          </label>
        </div>
        <div id="writeoff-list-table-wrapper"></div>
      </div>
    </div>
  </div>

  <script>
    const COLS = 6;
    const ROWS = 5;
    const TOTAL_CELLS = ROWS * COLS;
    const COLOR_CLASSES = ['grey', 'green', 'orange', 'red'];
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxGVZusGYvG-9b3mLz7UxSZJooAUa4Tdypofp_XUl6bLsmKurfmE6ZwHH9RfErxBRncog/exec';

    const grid = document.getElementById('grid');
    const baseCharCode = 'A'.charCodeAt(0);
    const overlay = document.getElementById('overlay');

    const writeoffPopup = document.getElementById('writeoff-popup');
    const writeoffClose = document.getElementById('writeoff-close');
    const writeoffTitle = document.getElementById('writeoff-title');
    const writeoffContent = document.getElementById('writeoff-content');

    const writeoffListPopup = document.getElementById('writeoff-list-popup');
    const writeoffListClose = document.getElementById('writeoff-list-close');
    const writeoffListButton = document.getElementById('writeoff-list-button');
    const writeoffDateInput = document.getElementById('writeoff-date-input');
    const writeoffListTableWrapper = document.getElementById('writeoff-list-table-wrapper');

    let tableRows = [];
    let statusMatrix = [];
    let products = [];
    let writeOffs = [];
    let syncTimeoutId = null;
    let observer = null;
    let elapsedTimerId = null;
    let writeoffCell = null;

    function indexFromRowCol(r, c) {
      return (r - 1) * COLS + (c - 1);
    }

    function createEmptyMatrix(rows, cols, value) {
      const matrix = [];
      for (let r = 0; r < rows; r += 1) {
        const row = [];
        for (let c = 0; c < cols; c += 1) {
          row.push(value);
        }
        matrix.push(row);
      }
      return matrix;
    }

    function buildTableFromValues(values) {
      const header = ['location', 'class', 'product', 'amount', 'start_time'];
      const rows = [];
      rows.push(header);

      for (let r = 1; r <= ROWS; r += 1) {
        for (let c = 1; c <= COLS; c += 1) {
          const idx = indexFromRowCol(r, c);
          const srcRow = values && values[idx + 1] ? values[idx + 1] : [];
          const canonicalLoc = String.fromCharCode(baseCharCode + c - 1) + r;

          let loc = srcRow[0];
          if (!loc || String(loc).trim() === '') {
            loc = canonicalLoc;
          }

          let color = srcRow[1];
          if (!color || COLOR_CLASSES.indexOf(String(color)) === -1) {
            color = 'grey';
          }

          let product = srcRow[2] || '';
          let amount = srcRow[3] || '';
          let startTime = srcRow[4] || '';

          rows.push([loc, color, product, amount, startTime]);
        }
      }
      return rows;
    }

    function tableToStatusMatrix(rows) {
      const matrix = createEmptyMatrix(ROWS, COLS, 'grey');
      for (let r = 1; r <= ROWS; r += 1) {
        for (let c = 1; c <= COLS; c += 1) {
          const idx = indexFromRowCol(r, c) + 1;
          const row = rows[idx];
          const color = row && row[1] ? row[1] : 'grey';
          matrix[r - 1][c - 1] = COLOR_CLASSES.indexOf(color) === -1 ? 'grey' : color;
        }
      }
      return matrix;
    }

    function buildProductsFromValues(rows) {
      const list = [];
      if (!rows) {
        return list;
      }
      for (let i = 0; i < rows.length; i += 1) {
        const row = rows[i] || [];
        const id = row[0];
        const title = row[1];
        if (!id || !title) {
          continue;
        }
        list.push({
          id: String(id).trim(),
          title: String(title).trim()
        });
      }
      return list;
    }

    function buildWriteOffsFromValues(rows) {
      const list = [];
      if (!rows) {
        return list;
      }
      for (let i = 0; i < rows.length; i += 1) {
        const row = rows[i] || [];
        const date = row[0] ? String(row[0]) : '';
        const time = row[1] ? String(row[1]) : '';
        const productId = row[2] ? String(row[2]) : '';
        const productTitle = row[3] ? String(row[3]) : '';
        const amount = row[4] ? String(row[4]) : '';
        if (!date && !time && !productId && !productTitle && !amount) {
          continue;
        }
        list.push({
          date: date,
          time: time,
          productId: productId,
          productTitle: productTitle,
          amount: amount
        });
      }
      return list;
    }

    function computeElapsedMinutes(startEpoch) {
      const base = Number(startEpoch);
      if (!base || base <= 0) {
        return 0;
      }
      const diffMs = Date.now() - base;
      if (diffMs <= 0) {
        return 0;
      }
      const minutes = Math.floor(diffMs / 60000);
      return minutes;
    }

    function computeElapsedLabel(startEpoch) {
      const minutes = computeElapsedMinutes(startEpoch);
      return String(minutes) + ' min';
    }

    function getProductTitleById(productId) {
      const idStr = String(productId);
      for (let i = 0; i < products.length; i += 1) {
        if (products[i].id === idStr) {
          return products[i].title;
        }
      }
      return '';
    }

    function formatProductDisplay(productId) {
      if (!productId) {
        return '';
      }
      const idStr = String(productId);
      const title = getProductTitleById(idStr);
      if (title) {
        return idStr + ' - ' + title;
      }
      return idStr;
    }

    function getDisplayCols() {
      const width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth || 0;
      let cols = Math.floor(width / 300);
      if (cols < 1) {
        cols = 1;
      }
      return cols;
    }

    function buildGridFromMatrix(matrix) {
      const displayCols = getDisplayCols();

      grid.innerHTML = '';
      for (let r = 1; r <= ROWS; r += 1) {
        for (let c = 1; c <= COLS; c += 1) {
          const cell = document.createElement('div');
          cell.classList.add('cell', 'row-' + r, 'col-' + c);
          cell.dataset.row = String(r);
          cell.dataset.col = String(c);

          cell.style.flex = '0 0 calc((100% - ' + (displayCols - 1) + ' * 15px) / ' + displayCols + ')';

          const color = matrix[r - 1][c - 1];
          if (COLOR_CLASSES.indexOf(color) === -1) {
            cell.classList.add('grey');
          } else {
            cell.classList.add(color);
          }

          const tableIndex = indexFromRowCol(r, c) + 1;
          const tRow = tableRows[tableIndex] || [];
          let productId = tRow[2] ? String(tRow[2]) : '';
          const cellIndex0 = indexFromRowCol(r, c);

          if (!productId && products && products[cellIndex0]) {
            productId = products[cellIndex0].id;
            tRow[2] = productId;
            tableRows[tableIndex] = tRow;
          }

          const amount = tRow[3] ? String(tRow[3]) : '';
          const startEpochStr = tRow[4] ? String(tRow[4]) : '';
          const startEpoch = startEpochStr && !isNaN(Number(startEpochStr)) ? Number(startEpochStr) : null;

          if (productId) {
            cell.classList.add(productId);
          }
          if (amount) {
            cell.classList.add('amount_' + amount);
          }
          if (startEpoch !== null) {
            cell.classList.add('start_time_' + startEpochStr);
            cell.dataset.startEpoch = startEpochStr;
          }

          const location = document.createElement('div');
          location.classList.add('location');
          const productDisplay = productId ? formatProductDisplay(productId) : '';
          location.textContent = productDisplay;

          const meta = document.createElement('div');
          meta.classList.add('cell-meta');

          const productDiv = document.createElement('div');
          productDiv.classList.add('cell-product');
          productDiv.textContent = productDisplay;

          const amountDiv = document.createElement('div');
          amountDiv.classList.add('cell-amount');
          amountDiv.textContent = amount ? 'aantal: ' + amount : '';

          const timeRow = document.createElement('div');
          timeRow.classList.add('cell-time-row');

          const timeDiv = document.createElement('div');
          timeDiv.classList.add('cell-time');
          if (startEpoch !== null) {
            timeDiv.textContent = 'tijd op locatie: ' + computeElapsedLabel(startEpochStr);
          } else {
            timeDiv.textContent = '';
          }

          const clearDiv = document.createElement('div');
          clearDiv.classList.add('cell-clear');
          clearDiv.textContent = 'ðŸ—‘';
          clearDiv.addEventListener('click', function (ev) {
            ev.stopPropagation();
            openWriteoffConfirm(cell);
          });

          timeRow.appendChild(timeDiv);
          timeRow.appendChild(clearDiv);

          const controls = document.createElement('div');
          controls.classList.add('cell-controls');

          const stockInput = document.createElement('input');
          stockInput.type = 'number';
          stockInput.min = '1';
          stockInput.step = '1';
          stockInput.value = amount ? String(amount) : '1';
          stockInput.classList.add('cell-stock-input');
          stockInput.inputMode = 'numeric';
          stockInput.pattern = '[0-9]*';

          const addButton = document.createElement('button');
          addButton.type = 'button';
          addButton.classList.add('cell-add-button');
          addButton.textContent = 'toevoegen';

          addButton.addEventListener('click', function (ev) {
            ev.stopPropagation();
            handleAddStock(cell, stockInput);
          });

          controls.appendChild(stockInput);
          controls.appendChild(addButton);

          meta.appendChild(productDiv);
          meta.appendChild(amountDiv);
          meta.appendChild(timeRow);
          meta.appendChild(controls);

          cell.appendChild(location);
          cell.appendChild(meta);

          grid.appendChild(cell);
        }
      }
    }

    function getCellColorClass(element) {
      for (let i = 0; i < COLOR_CLASSES.length; i += 1) {
        const cls = COLOR_CLASSES[i];
        if (element.classList.contains(cls)) {
          return cls;
        }
      }
      return 'grey';
    }

    function scheduleSync() {
      if (syncTimeoutId !== null) {
        clearTimeout(syncTimeoutId);
      }
      syncTimeoutId = setTimeout(function () {
        syncTimeoutId = null;
        sendStatusToSheet();
      }, 500);
    }

    function startObserver() {
      observer = new MutationObserver(function (mutations) {
        let changed = false;
        for (let i = 0; i < mutations.length; i += 1) {
          const mutation = mutations[i];
          if (mutation.type !== 'attributes') {
            continue;
          }
          if (mutation.attributeName !== 'class') {
            continue;
          }
          const element = mutation.target;
          if (!element.dataset || !element.dataset.row || !element.dataset.col) {
            continue;
          }
          const rowIndex = parseInt(element.dataset.row, 10) - 1;
          const colIndex = parseInt(element.dataset.col, 10) - 1;
          if (rowIndex < 0 || colIndex < 0) {
            continue;
          }
          const color = getCellColorClass(element);
          if (statusMatrix[rowIndex][colIndex] !== color) {
            statusMatrix[rowIndex][colIndex] = color;
            const idx = indexFromRowCol(rowIndex + 1, colIndex + 1) + 1;
            if (tableRows[idx]) {
              tableRows[idx][1] = color;
            }
            changed = true;
          }
        }
        if (changed) {
          scheduleSync();
        }
      });

      observer.observe(grid, {
        attributes: true,
        attributeFilter: ['class'],
        subtree: true
      });
    }

    async function fetchSheetData() {
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'GET'
        });
        if (!response.ok) {
          return null;
        }
        const data = await response.json();
        return data;
      } catch (e) {
        return null;
      }
    }

    async function sendStatusToSheet() {
      try {
        const payload = { values: tableRows };
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8'
          },
          body: JSON.stringify(payload)
        });
      } catch (e) {
      }
    }

    async function sendWriteOff(productId, productTitle, amount) {
      try {
        const payload = {
          values: tableRows,
          writeOffs: [{
            productId: productId,
            productTitle: productTitle,
            amount: String(amount)
          }]
        };
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8'
          },
          body: JSON.stringify(payload)
        });
      } catch (e) {
      }
    }

    function openWriteoffConfirm(cell) {
      writeoffCell = cell;

      const locEl = cell.querySelector('.location');
      const locLabel = locEl ? locEl.textContent : '';

      writeoffTitle.textContent = 'Product afschrijven?';
      writeoffContent.innerHTML = '';

      const msg = document.createElement('div');
      msg.textContent = 'Product ' + locLabel;

      const buttons = document.createElement('div');
      buttons.style.display = 'flex';
      buttons.style.gap = '10px';
      buttons.style.marginTop = '14px';
      buttons.style.justifyContent = 'center';

      function makeButton(label) {
        const b = document.createElement('button');
        b.textContent = label;
        b.style.padding = '8px 18px';
        b.style.borderRadius = '999px';
        b.style.border = '1px solid '#000000';
        b.style.background = '#ffffff';
        b.style.cursor = 'pointer';
        b.style.fontSize = '0.9rem';
        return b;
      }

      const btnJa = makeButton('ja');
      const btnNee = makeButton('nee');
      const btnAnnuleren = makeButton('annuleren');

      btnJa.addEventListener('click', function () {
        openWriteoffAmountStep();
      });

      btnNee.addEventListener('click', function () {
        clearLocation(cell);
        closeWriteoffPopup();
      });

      btnAnnuleren.addEventListener('click', function () {
        closeWriteoffPopup();
      });

      buttons.appendChild(btnJa);
      buttons.appendChild(btnNee);
      buttons.appendChild(btnAnnuleren);

      writeoffContent.appendChild(msg);
      writeoffContent.appendChild(buttons);

      overlay.classList.add('active');
      writeoffPopup.classList.add('active');
    }

    function openWriteoffAmountStep() {
      if (!writeoffCell) {
        closeWriteoffPopup();
        return;
      }
      const rowIndex = parseInt(writeoffCell.dataset.row, 10);
      const colIndex = parseInt(writeoffCell.dataset.col, 10);
      const tableIndex = indexFromRowCol(rowIndex, colIndex) + 1;
      const record = tableRows[tableIndex];
      if (!record) {
        closeWriteoffPopup();
        return;
      }

      const productId = record[2] ? String(record[2]) : '';
      const amountStr = record[3] ? String(record[3]) : '';
      let maxAmount = parseInt(amountStr, 10);
      if (!maxAmount || maxAmount < 1) {
        maxAmount = 1;
      }

      const productDisplay = formatProductDisplay(productId);
      const productTitle = getProductTitleById(productId);

      writeoffTitle.textContent = 'Product afschrijven';
      writeoffContent.innerHTML = '';

      const info = document.createElement('div');
      info.innerHTML = 'Product <strong>' + productDisplay + '</strong>';

      const amountWrap = document.createElement('div');
      amountWrap.style.marginTop = '10px';

      const amountLabel = document.createElement('div');
      amountLabel.textContent = 'Aantal af te schrijven (max ' + String(maxAmount) + '):';

      const amountInput = document.createElement('input');
      amountInput.id = 'writeoff-amount-input';
      amountInput.type = 'number';
      amountInput.min = '1';
      amountInput.max = String(maxAmount);
      amountInput.step = '1';
      amountInput.value = String(maxAmount);
      amountInput.style.marginTop = '6px';
      amountInput.style.width = '100px';
      amountInput.style.padding = '6px 8px';
      amountInput.style.borderRadius = '6px';
      amountInput.style.border = '1px solid #cccccc';
      amountInput.style.textAlign = 'center';
      amountInput.inputMode = 'numeric';
      amountInput.pattern = '[0-9]*';

      amountWrap.appendChild(amountLabel);
      amountWrap.appendChild(amountInput);

      const buttons = document.createElement('div');
      buttons.style.display = 'flex';
      buttons.style.gap = '10px';
      buttons.style.marginTop = '14px';
      buttons.style.justifyContent = 'center';

      function makeButton(label, filled) {
        const b = document.createElement('button');
        b.textContent = label;
        b.style.padding = '8px 18px';
        b.style.borderRadius = '999px';
        b.style.cursor = 'pointer';
        b.style.fontSize = '0.9rem';
        if (filled) {
          b.style.background = '#000000';
          b.style.color = '#ffffff';
          b.style.border = '1px solid #000000';
        } else {
          b.style.background = '#ffffff';
          b.style.color = '#000000';
          b.style.border = '1px solid #000000';
        }
        return b;
      }

      const btnAfschrijven = makeButton('afschrijven', true);
      const btnAnnuleren = makeButton('annuleren', false);

      btnAfschrijven.addEventListener('click', function () {
        let selected = parseInt(amountInput.value, 10);
        if (!selected || selected < 1) {
          selected = 1;
        }
        if (selected > maxAmount) {
          selected = maxAmount;
        }
        handleWriteoffConfirm(productId, productTitle, selected);
      });

      btnAnnuleren.addEventListener('click', function () {
        closeWriteoffPopup();
      });

      buttons.appendChild(btnAfschrijven);
      buttons.appendChild(btnAnnuleren);

      writeoffContent.appendChild(info);
      writeoffContent.appendChild(amountWrap);
      writeoffContent.appendChild(buttons);
    }

    function closeWriteoffPopup() {
      writeoffPopup.classList.remove('active');
      writeoffContent.innerHTML = '';
      writeoffCell = null;
      const otherOpen = writeoffListPopup.classList.contains('active');
      if (!otherOpen) {
        overlay.classList.remove('active');
      }
    }

    function clearLocation(cell) {
      const row = parseInt(cell.dataset.row, 10);
      const col = parseInt(cell.dataset.col, 10);
      if (!row || !col) {
        return;
      }
      const tableIndex = indexFromRowCol(row, col) + 1;
      if (!tableRows[tableIndex]) {
        return;
      }

      const currentProductId = tableRows[tableIndex][2] ? String(tableRows[tableIndex][2]) : '';

      tableRows[tableIndex][1] = 'grey';
      tableRows[tableIndex][3] = '';
      tableRows[tableIndex][4] = '';

      cell.dataset.startEpoch = '';

      const existing = [];
      for (let i = 0; i < cell.classList.length; i += 1) {
        existing.push(cell.classList.item(i));
      }

      for (let i = 0; i < products.length; i += 1) {
        cell.classList.remove(products[i].id);
      }

      for (let i = 0; i < existing.length; i += 1) {
        const cls = existing[i];
        if (cls.indexOf('amount_') === 0 || cls.indexOf('start_time_') === 0) {
          cell.classList.remove(cls);
        }
      }

      for (let i = 0; i < COLOR_CLASSES.length; i += 1) {
        cell.classList.remove(COLOR_CLASSES[i]);
      }
      cell.classList.add('grey');

      const meta = cell.querySelector('.cell-meta');
      if (meta) {
        const productDiv = meta.querySelector('.cell-product');
        const amountDiv = meta.querySelector('.cell-amount');
        const timeDiv = meta.querySelector('.cell-time');
        if (productDiv) {
          productDiv.textContent = currentProductId ? formatProductDisplay(currentProductId) : '';
        }
        if (amountDiv) {
          amountDiv.textContent = '';
        }
        if (timeDiv) {
          timeDiv.textContent = '';
        }
      }

      const rowIndex = row - 1;
      const colIndex = col - 1;
      if (rowIndex >= 0 && colIndex >= 0 && rowIndex < ROWS && colIndex < COLS) {
        statusMatrix[rowIndex][colIndex] = 'grey';
      }

      scheduleSync();
    }

    function handleWriteoffConfirm(productId, productTitle, amount) {
      if (!writeoffCell) {
        closeWriteoffPopup();
        return;
      }
      clearLocation(writeoffCell);
      sendWriteOff(productId, productTitle, amount);
      closeWriteoffPopup();
      updateElapsedTimes();
    }

    function updateCellForSelection(cell, tableIndex, productId, amount, startEpochStr) {
      if (!tableRows[tableIndex]) {
        return;
      }

      tableRows[tableIndex][2] = productId;
      tableRows[tableIndex][3] = String(amount);
      tableRows[tableIndex][4] = startEpochStr;

      const existing = [];
      for (let i = 0; i < cell.classList.length; i += 1) {
        existing.push(cell.classList.item(i));
      }

      for (let i = 0; i < products.length; i += 1) {
        cell.classList.remove(products[i].id);
      }

      for (let i = 0; i < existing.length; i += 1) {
        const cls = existing[i];
        if (cls.indexOf('amount_') === 0 || cls.indexOf('start_time_') === 0) {
          cell.classList.remove(cls);
        }
      }

      for (let i = 0; i < COLOR_CLASSES.length; i += 1) {
        cell.classList.remove(COLOR_CLASSES[i]);
      }
      cell.classList.add('green');

      if (productId) {
        cell.classList.add(productId);
      }
      cell.classList.add('amount_' + String(amount));
      cell.classList.add('start_time_' + startEpochStr);
      cell.dataset.startEpoch = startEpochStr;

      const meta = cell.querySelector('.cell-meta');
      if (meta) {
        const productDiv = meta.querySelector('.cell-product');
        const amountDiv = meta.querySelector('.cell-amount');
        const timeDiv = meta.querySelector('.cell-time');
        const productDisplay = productId ? formatProductDisplay(productId) : '';
        if (productDiv) {
          productDiv.textContent = productDisplay;
        }
        if (amountDiv) {
          amountDiv.textContent = amount ? 'aantal: ' + String(amount) : '';
        }
        if (timeDiv) {
          timeDiv.textContent = 'tijd op locatie: ' + computeElapsedLabel(startEpochStr);
        }

        const header = cell.querySelector('.location');
        if (header) {
          header.textContent = productDisplay;
        }
      }
    }

    function handleAddStock(cell, inputElement) {
      const row = parseInt(cell.dataset.row, 10);
      const col = parseInt(cell.dataset.col, 10);
      if (!row || !col) {
        return;
      }
      const tableIndex = indexFromRowCol(row, col) + 1;
      const record = tableRows[tableIndex];
      if (!record) {
        return;
      }
      const productId = record[2] ? String(record[2]) : '';
      if (!productId) {
        return;
      }

      const raw = inputElement ? inputElement.value : '';
      let amount = parseInt(raw, 10);
      if (!amount || amount < 1) {
        amount = 1;
      }

      const now = Date.now();
      const startEpochStr = String(now);

      updateCellForSelection(cell, tableIndex, productId, amount, startEpochStr);
      scheduleSync();
      updateElapsedTimes();
    }

    function updateElapsedTimes() {
      const cells = grid.querySelectorAll('.cell');
      for (let i = 0; i < cells.length; i += 1) {
        const cell = cells[i];
        const startEpochStr = cell.dataset.startEpoch;
        if (!startEpochStr) {
          continue;
        }
        const meta = cell.querySelector('.cell-meta');
        if (!meta) {
          continue;
        }
        const timeDiv = meta.querySelector('.cell-time');
        if (!timeDiv) {
          continue;
        }

        const minutes = computeElapsedMinutes(startEpochStr);
        timeDiv.textContent = 'tijd op locatie: ' + String(minutes) + ' min';

        let newColor = 'green';
        if (minutes > 105 && minutes < 120) {
          newColor = 'orange';
        } else if (minutes >= 120) {
          newColor = 'red';
        }

        const currentColor = getCellColorClass(cell);
        if (currentColor !== newColor) {
          for (let j = 0; j < COLOR_CLASSES.length; j += 1) {
            cell.classList.remove(COLOR_CLASSES[j]);
          }
          cell.classList.add(newColor);
        }
      }
    }

    function getTodayDateString() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      const day = now.getDate();
      const mm = month < 10 ? '0' + month : String(month);
      const dd = day < 10 ? '0' + day : String(day);
      return year + '-' + mm + '-' + dd;
    }

    function sheetDateToInputFormat(sheetDateStr) {
      if (!sheetDateStr) {
        return '';
      }
      const s = String(sheetDateStr).trim();
      const parts = s.split('-');
      if (parts.length !== 3) {
        return '';
      }
      const d = parts[0];
      const m = parts[1];
      const y = parts[2];
      const dd = d.length === 1 ? '0' + d : d;
      const mm = m.length === 1 ? '0' + m : m;
      return y + '-' + mm + '-' + dd;
    }

    function renderWriteoffListForDate(inputDateStr) {
      if (!writeoffListTableWrapper) {
        return;
      }
      writeoffListTableWrapper.innerHTML = '';
      const targetDate = inputDateStr;
      const list = [];
      for (let i = 0; i < writeOffs.length; i += 1) {
        const w = writeOffs[i];
        const converted = sheetDateToInputFormat(w.date);
        if (converted === targetDate) {
          list.push(w);
        }
      }

      if (list.length === 0) {
        const empty = document.createElement('div');
        empty.classList.add('writeoff-empty');
        empty.textContent = 'Geen afschrijvingen voor deze datum.';
        writeoffListTableWrapper.appendChild(empty);
        return;
      }

      const table = document.createElement('table');
      table.classList.add('writeoff-table');

      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      const headers = ['Tijd', 'Product ID', 'Product', 'Aantal'];
      for (let i = 0; i < headers.length; i += 1) {
        const th = document.createElement('th');
        th.textContent = headers[i];
        headRow.appendChild(th);
      }
      thead.appendChild(headRow);

      const tbody = document.createElement('tbody');
      for (let i = 0; i < list.length; i += 1) {
        const w = list[i];
        const tr = document.createElement('tr');

        const tdTime = document.createElement('td');
        tdTime.textContent = w.time;

        const tdId = document.createElement('td');
        tdId.textContent = w.productId;

        const tdTitle = document.createElement('td');
        tdTitle.textContent = w.productTitle;

        const tdAmount = document.createElement('td');
        tdAmount.textContent = w.amount;

        tr.appendChild(tdTime);
        tr.appendChild(tdId);
        tr.appendChild(tdTitle);
        tr.appendChild(tdAmount);

        tbody.appendChild(tr);
      }

      table.appendChild(thead);
      table.appendChild(tbody);
      writeoffListTableWrapper.appendChild(table);
    }

    async function refreshWriteOffsFromSheet() {
      const sheetData = await fetchSheetData();
      if (!sheetData || !sheetData.writeOffs) {
        writeOffs = [];
        return;
      }
      const writeOffValues = sheetData.writeOffs;
      writeOffs = buildWriteOffsFromValues(writeOffValues);
    }

    function closeWriteoffListPopup() {
      writeoffListPopup.classList.remove('active');
      const otherOpen = writeoffPopup.classList.contains('active');
      if (!otherOpen) {
        overlay.classList.remove('active');
      }
    }

    async function init() {
      writeoffClose.addEventListener('click', function () {
        closeWriteoffPopup();
      });
      writeoffListClose.addEventListener('click', function () {
        closeWriteoffListPopup();
      });

      writeoffListButton.addEventListener('click', function () {
        const todayStr = getTodayDateString();
        writeoffDateInput.value = todayStr;

        writeoffListTableWrapper.innerHTML = '';
        const loading = document.createElement('div');
        loading.classList.add('writeoff-empty');
        loading.textContent = 'Laden...';
        writeoffListTableWrapper.appendChild(loading);

        overlay.classList.add('active');
        writeoffListPopup.classList.add('active');

        refreshWriteOffsFromSheet().then(function () {
          renderWriteoffListForDate(writeoffDateInput.value);
        });
      });

      writeoffDateInput.addEventListener('change', function () {
        renderWriteoffListForDate(writeoffDateInput.value);
      });

      overlay.addEventListener('click', function () {
        closeWriteoffPopup();
        closeWriteoffListPopup();
      });

      const sheetData = await fetchSheetData();
      const sheetValues = sheetData && sheetData.values ? sheetData.values : null;
      const productValues = sheetData && sheetData.products ? sheetData.products : null;
      const writeOffValues = sheetData && sheetData.writeOffs ? sheetData.writeOffs : null;

      tableRows = buildTableFromValues(sheetValues);
      products = buildProductsFromValues(productValues);
      writeOffs = buildWriteOffsFromValues(writeOffValues);
      statusMatrix = tableToStatusMatrix(tableRows);
      buildGridFromMatrix(statusMatrix);
      startObserver();
      sendStatusToSheet();
      updateElapsedTimes();
      elapsedTimerId = setInterval(updateElapsedTimes, 60000);

      window.addEventListener('resize', function () {
        buildGridFromMatrix(statusMatrix);
      });
    }

    init();
  </script>
</body>
</html>
