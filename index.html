<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Back-werk stock system</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    body {
      display: flex;
      flex-direction: column;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   sans-serif;
      background: #f5f5f5;
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px 15px;
      background: #ffffff;
      border-bottom: 1px solid #dddddd;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: #fafafa;
      border: 1px solid #eeeeee;
      flex: 0 0 auto;
    }

    .logo svg {
      display: block;
      width: 34px;
      height: 34px;
    }

    .title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .app-title {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 700;
      letter-spacing: 0.2px;
      color: #111111;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .app-subtitle {
      margin: 0;
      font-size: 0.85rem;
      color: #666666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header-actions {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      flex: 0 0 auto;
    }

    .sync-indicator {
      font-size: 0.85rem;
      color: #666666;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .sync-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #bbbbbb;
      flex: 0 0 auto;
    }

    .sync-dot.ok {
      background: #2c9c3a;
    }

    .sync-dot.pending {
      background: #f0b400;
    }

    .sync-dot.error {
      background: #d24b4b;
    }

    .button {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      background: #0b67d0;
      color: #ffffff;
      transition: background 150ms ease-out;
      white-space: nowrap;
    }

    .button.secondary {
      background: #ffffff;
      color: #0b67d0;
      border: 1px solid #0b67d0;
    }

    .button:active {
      transform: translateY(1px);
    }

    .button:disabled {
      cursor: default;
      opacity: 0.65;
    }

    .main {
      flex: 1;
      padding: 15px;
      box-sizing: border-box;
      position: relative;
      z-index: 0;
    }

    .grid {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      width: 100%;
      height: 500%;
      box-sizing: border-box;
      align-content: flex-start;
    }

    .cell {
      box-sizing: border-box;
      flex: 0 0 calc((100% - 5 * 15px) / 6);
      height: calc((100% - 4 * 15px) / 5);
      border-radius: 10px;
      position: relative;
      background: #e0e0e0;
      transition: background 150ms ease-out, box-shadow 150ms ease-out, transform 150ms ease-out;
      cursor: default;
      overflow: hidden;
      max-height: 120px;
    }

    .cell:hover {
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }

    .location {
      position: absolute;
      top: 8px;
      left: 10px;
      right: 10px;
      font-weight: 700;
      font-size: 0.85rem;
      color: #111111;
      z-index: 2;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      pointer-events: none;
    }

    .cell-meta {
      position: absolute;
      left: 10px;
      right: 10px;
      bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      z-index: 2;
    }

    .cell-product {
      font-size: 0.78rem;
      font-weight: 600;
      color: #1b1b1b;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cell-amount {
      font-size: 0.76rem;
      color: #333333;
    }

    .cell-time-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .cell-time {
      font-size: 0.72rem;
      color: #555555;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cell-clear {
      font-size: 1rem;
      line-height: 1;
      cursor: pointer;
      user-select: none;
      flex: 0 0 auto;
    }

    .cell-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 2px;
    }

    .cell-stock-input {
      width: 70px;
      padding: 8px 8px;
      border-radius: 10px;
      border: 1px solid #cccccc;
      font-size: 0.9rem;
      flex: 0 0 auto;
      background: #ffffff;
    }

    .cell-add-button {
      border: none;
      border-radius: 10px;
      padding: 9px 10px;
      font-size: 0.85rem;
      font-weight: 700;
      cursor: pointer;
      background: #0b67d0;
      color: #ffffff;
      flex: 1;
      transition: background 150ms ease-out;
    }

    .cell-add-button:active {
      transform: translateY(1px);
    }

    .green {
      background: #8fe59b;
    }

    .orange {
      background: #ffcd72;
    }

    .grey {
      background: #e0e0e0;
    }

    .red {
      background: #ffa1a1;
    }

    .popup {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .popup.visible {
      display: flex;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      z-index: 30;
    }

    .overlay.visible {
      display: block;
    }

    .popup-panel {
      background: #ffffff;
      border-radius: 18px;
      width: min(460px, calc(100% - 30px));
      max-height: min(90vh, 640px);
      overflow: hidden;
      box-shadow: 0 18px 55px rgba(0,0,0,0.22);
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }

    .popup-header {
      padding: 14px 16px;
      border-bottom: 1px solid #eeeeee;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .popup-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 800;
      color: #111111;
      flex: 1;
    }

    .popup-close {
      cursor: pointer;
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 700;
      color: #0b67d0;
      border: 1px solid #0b67d0;
      background: #ffffff;
      user-select: none;
    }

    .popup-body {
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .popup-body label {
      font-size: 0.85rem;
      font-weight: 700;
      color: #333333;
    }

    .popup-body input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #cccccc;
      font-size: 0.95rem;
      box-sizing: border-box;
    }

    .popup-actions {
      padding: 14px 16px;
      border-top: 1px solid #eeeeee;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .popup-actions .button.secondary {
      padding: 10px 14px;
    }

    .popup-actions .button {
      padding: 10px 14px;
    }

    .writeoff-list-panel {
      max-width: 720px;
      width: min(720px, calc(100% - 30px));
      max-height: min(90vh, 720px);
      overflow: hidden;
      box-shadow: 0 18px 55px rgba(0,0,0,0.22);
      background: #ffffff;
      border-radius: 18px;
      display: flex;
      flex-direction: column;
    }

    .writeoff-list-body {
      overflow: auto;
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .writeoff-item {
      border: 1px solid #eeeeee;
      border-radius: 14px;
      padding: 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #fafafa;
    }

    .writeoff-item-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .writeoff-item-title {
      font-weight: 800;
      font-size: 0.95rem;
      color: #111111;
    }

    .writeoff-item-meta {
      font-size: 0.82rem;
      color: #555555;
      text-align: right;
      flex: 0 0 auto;
    }

    .writeoff-item-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .writeoff-item-actions .button {
      font-size: 0.85rem;
      padding: 9px 12px;
      border-radius: 12px;
    }

    .writeoff-item-actions .button.secondary {
      border-radius: 12px;
    }

    .writeoff-list-empty {
      font-size: 0.9rem;
      color: #666666;
      text-align: center;
      padding: 24px 10px;
    }

    .writeoff-confirm-panel {
      max-width: 460px;
      width: min(460px, calc(100% - 30px));
      max-height: min(90vh, 640px);
      overflow: hidden;
      box-shadow: 0 18px 55px rgba(0,0,0,0.22);
      background: #ffffff;
      border-radius: 18px;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }

    .writeoff-confirm-body {
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .writeoff-confirm-body p {
      margin: 0;
      color: #333333;
      font-size: 0.9rem;
      line-height: 1.35;
    }

    .writeoff-confirm-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    .writeoff-confirm-row label {
      font-size: 0.85rem;
      font-weight: 700;
      color: #333333;
    }

    .writeoff-confirm-row textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #cccccc;
      padding: 10px 12px;
      font-size: 0.9rem;
      box-sizing: border-box;
      resize: vertical;
      min-height: 84px;
      font-family: inherit;
    }

    .writeoff-confirm-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 14px;
      background: #fafafa;
      border-radius: 14px;
      border: 1px solid #eeeeee;
      padding: 12px 12px;
    }

    .writeoff-confirm-info div {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .writeoff-confirm-info span {
      font-size: 0.78rem;
      color: #666666;
      font-weight: 700;
    }

    .writeoff-confirm-info strong {
      font-size: 0.9rem;
      color: #111111;
      font-weight: 800;
      word-break: break-word;
    }

    .writeoff-summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
    }

    .writeoff-summary-table th,
    .writeoff-summary-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #eeeeee;
      text-align: left;
    }

    .writeoff-empty {
      font-size: 0.85rem;
      text-align: center;
      margin-top: 6px;
    }
  

    .grid-container {
      display: flex;
      flex-direction: column;
      gap: 22px;
      width: 100%;
      box-sizing: border-box;
    }

    .category-title {
      font-weight: 700;
      font-size: 0.95rem;
      margin: 4px 2px 0;
    }

    .category-grid {
      height: auto;
    }

    .category-grid .cell {
      height: 120px;
      max-height: 120px;
    }

  </style>
</head>
<body>
  <header class="header">
    <div class="header-top">
      <div class="logo-wrap">
        <div class="logo">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 124.72 22.68">
            <defs>
              <style>.a{fill:#000000;}</style>
            </defs>
            <path class="a" d="M.24,1h9.1c4.72,0,7.57,3.39,7.57,7.28s-2.85,7.25-7.57,7.25H.24ZM8.62,12.74A4.07,4.07,0,0,0,12.79,8.3,4.07,4.07,0,0,0,8.62,3.86H3.42V12.74Z"/>
            <path class="a" d="M18.65,1H21.8v7.9a3.87,3.87,0,1,0,7.73,0V1h3.14V9a6.38,6.38,0,1,1-12.72,0Z"/>
            <path class="a" d="M45.86,1h3.27L55.2,16.53H51.54l-1.06-2.91H44.36l-1,2.91H39.78ZM49.47,11l-2-5.56L45.48,11Z"/>
            <path class="a" d="M57.38,1h3.18L65,11.8,69.46,1h3.19L66.52,16.53H63.5Z"/>
            <path class="a" d="M74.88,1H86.05V3.86H78.05V7.16H85.9v2.86H78.05v3.68h8.1v2.83H74.88Z"/>
            <path class="a" d="M88.62,1h3.17l6.58,9.26V1h3.17V16.53H98.45L91.79,7.23v9.3H88.62Z"/>
            <path class="a" d="M107.59,3.86h-4.71V1h12.6V3.86h-4.71V16.53h-3.18Z"/>
            <path class="a" d="M116,1h3.17V16.53H116Z"/>
            <path class="a" d="M121.44,1h3.28l-5,15.56H116.5Z"/>
          </svg>
        </div>
        <div class="title-wrap">
          <h1 class="app-title">Back-werk stock system</h1>
          <p class="app-subtitle">Voorraad over locaties (Google Sheet sync)</p>
        </div>
      </div>
      <div class="header-actions">
        <div class="sync-indicator" id="syncIndicator">
          <span class="sync-dot" id="syncDot"></span>
          <span id="syncLabel">sync idle</span>
        </div>
        <button class="button secondary" id="writeoffButton" type="button">afschrijvingen</button>
      </div>
    </div>
  </header>

  <main class="main">
    <div id="grid" class="grid-container"></div>
  </main>

  <div id="overlay" class="overlay"></div>

  <div id="writeoffOverlay" class="overlay"></div>

  <div id="writeoffListPopup" class="popup">
    <div class="writeoff-list-panel">
      <div class="popup-header">
        <h2 class="popup-title">Afschrijvingen</h2>
        <div class="popup-close" id="writeoffListClose">sluiten</div>
      </div>
      <div class="writeoff-list-body" id="writeoffListBody">
        <div class="writeoff-list-empty">Geen afschrijvingen gevonden.</div>
      </div>
      <div class="popup-actions">
        <button class="button secondary" id="writeoffListRefresh" type="button">verversen</button>
      </div>
    </div>
  </div>

  <div id="writeoffConfirmPopup" class="popup">
    <div class="writeoff-confirm-panel">
      <div class="popup-header">
        <h2 class="popup-title">Afschrijven</h2>
        <div class="popup-close" id="writeoffConfirmClose">sluiten</div>
      </div>
      <div class="writeoff-confirm-body">
        <p>Weet je zeker dat je deze locatie wil afschrijven?</p>
        <div class="writeoff-confirm-info">
          <div>
            <span>Locatie</span>
            <strong id="writeoffLoc"></strong>
          </div>
          <div>
            <span>Product</span>
            <strong id="writeoffProd"></strong>
          </div>
          <div>
            <span>Aantal</span>
            <strong id="writeoffAmt"></strong>
          </div>
          <div>
            <span>Tijd op locatie</span>
            <strong id="writeoffTime"></strong>
          </div>
        </div>
        <div class="writeoff-confirm-row">
          <label for="writeoffReason">Reden</label>
          <textarea id="writeoffReason" placeholder="Bijv. verlopen, beschadigd, etc."></textarea>
        </div>
      </div>
      <div class="popup-actions">
        <button class="button secondary" id="writeoffCancel" type="button">annuleren</button>
        <button class="button" id="writeoffConfirm" type="button">afschrijven</button>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx8uCq2s6nZBy9Y4Tdypofp_XUl6bLsmKurfmE6ZwHH9RfErxBRncog/exec';
    const grid = document.getElementById('grid');
    const baseCharCode = 'A'.charCodeAt(0);
    const ROWS = 5;
    const COLS = 6;
    const TOTAL_CELLS = ROWS * COLS;

    const COLOR_CLASSES = ['green', 'orange', 'grey', 'red'];

    let tableRows = [];
    let products = null;
    let matrix = createEmptyMatrix();
    let pendingSync = false;
    let syncTimer = null;
    let syncError = '';
    let lastSheetLoadMs = 0;
    let lastWriteoffLoadMs = 0;
    let writeoffRows = [];

    const syncIndicator = document.getElementById('syncIndicator');
    const syncDot = document.getElementById('syncDot');
    const syncLabel = document.getElementById('syncLabel');
    const writeoffButton = document.getElementById('writeoffButton');

    const overlay = document.getElementById('overlay');

    const writeoffOverlay = document.getElementById('writeoffOverlay');
    const writeoffListPopup = document.getElementById('writeoffListPopup');
    const writeoffListBody = document.getElementById('writeoffListBody');
    const writeoffListClose = document.getElementById('writeoffListClose');
    const writeoffListRefresh = document.getElementById('writeoffListRefresh');

    const writeoffConfirmPopup = document.getElementById('writeoffConfirmPopup');
    const writeoffConfirmClose = document.getElementById('writeoffConfirmClose');
    const writeoffCancel = document.getElementById('writeoffCancel');
    const writeoffConfirm = document.getElementById('writeoffConfirm');
    const writeoffLoc = document.getElementById('writeoffLoc');
    const writeoffProd = document.getElementById('writeoffProd');
    const writeoffAmt = document.getElementById('writeoffAmt');
    const writeoffTime = document.getElementById('writeoffTime');
    const writeoffReason = document.getElementById('writeoffReason');

    let writeoffTargetCell = null;

    function createEmptyMatrix() {
      const arr = [];
      for (let r = 0; r < ROWS; r += 1) {
        const row = [];
        for (let c = 0; c < COLS; c += 1) {
          row.push('grey');
        }
        arr.push(row);
      }
      return arr;
    }

    function indexFromRowCol(row, col) {
      return (row - 1) * COLS + (col - 1);
    }

    function rowColFromIndex(index) {
      const row = Math.floor(index / COLS) + 1;
      const col = (index % COLS) + 1;
      return { row: row, col: col };
    }

    function locationLabel(row, col) {
      const letter = String.fromCharCode(baseCharCode + (row - 1));
      return letter + col;
    }

    function computeElapsedLabel(startEpochStr) {
      if (!startEpochStr) {
        return '';
      }
      const startEpoch = Number(startEpochStr);
      if (!startEpoch || isNaN(startEpoch)) {
        return '';
      }
      const now = Date.now();
      const diffMs = now - startEpoch;
      if (diffMs < 0) {
        return '0m';
      }
      const diffMin = Math.floor(diffMs / 60000);
      const days = Math.floor(diffMin / (60 * 24));
      const hours = Math.floor((diffMin - days * 60 * 24) / 60);
      const mins = diffMin - days * 60 * 24 - hours * 60;
      const parts = [];
      if (days > 0) {
        parts.push(days + 'd');
      }
      if (hours > 0) {
        parts.push(hours + 'u');
      }
      parts.push(mins + 'm');
      return parts.join(' ');
    }

    function setSyncState(state, label) {
      syncDot.classList.remove('ok', 'pending', 'error');
      if (state === 'ok') {
        syncDot.classList.add('ok');
      }
      if (state === 'pending') {
        syncDot.classList.add('pending');
      }
      if (state === 'error') {
        syncDot.classList.add('error');
      }
      syncLabel.textContent = label;
    }

    function scheduleSync() {
      pendingSync = true;
      setSyncState('pending', 'sync pending');
      if (syncTimer) {
        clearTimeout(syncTimer);
      }
      syncTimer = setTimeout(function () {
        syncTimer = null;
        if (pendingSync) {
          syncChanges();
        }
      }, 800);
    }

    function updateMatrixFromRows(rows) {
      matrix = createEmptyMatrix();
      for (let i = 1; i < rows.length; i += 1) {
        const row = rows[i];
        const rowIndex = Number(row[0]);
        const colIndex = Number(row[1]);
        const color = row[2];
        if (rowIndex >= 1 && rowIndex <= ROWS && colIndex >= 1 && colIndex <= COLS) {
          if (COLOR_CLASSES.indexOf(color) !== -1) {
            matrix[rowIndex - 1][colIndex - 1] = color;
          } else {
            matrix[rowIndex - 1][colIndex - 1] = 'grey';
          }
        }
      }
    }

    function parseSheetRows(data) {
      if (!data || !data.rows || !Array.isArray(data.rows)) {
        return [];
      }
      return data.rows;
    }

    function parseProducts(data) {
      if (!data || !data.products || !Array.isArray(data.products)) {
        return null;
      }
      return data.products;
    }

    function getProductTitleById(idStr) {
      if (!products || !Array.isArray(products)) {
        return '';
      }
      for (let i = 0; i < products.length; i += 1) {
        if (products[i].id === idStr) {
          return products[i].title;
        }
      }
      return '';
    }

    function formatProductDisplay(productId) {
      if (!productId) {
        return '';
      }
      const idStr = String(productId);
      const title = getProductTitleById(idStr);
      if (title) {
        return idStr + ' - ' + title;
      }
      return idStr;
    }

    function getDisplayCols() {
      const width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth || 0;
      let cols = Math.floor(width / 300);
      if (cols < 1) {
        cols = 1;
      }
      return cols;
    }

    function getDisplayRows(cols) {
      const total = TOTAL_CELLS;
      const rows = Math.ceil(total / cols);
      return rows < 1 ? 1 : rows;
    }

    function getProductCategory(productId) {
      const s = String(productId || '').trim();
      if (!s) {
        return '';
      }
      const m = s.match(/^\d/);
      return m ? m[0] : '';
    }

    function makeCell(r, c, matrix, displayCols) {
      const cell = document.createElement('div');
      cell.classList.add('cell', 'row-' + r, 'col-' + c);
      cell.dataset.row = String(r);
      cell.dataset.col = String(c);

      cell.style.flex = '0 0 calc((100% - ' + (displayCols - 1) + ' * 15px) / ' + displayCols + ')';

      const color = matrix[r - 1][c - 1];
      if (COLOR_CLASSES.indexOf(color) === -1) {
        cell.classList.add('grey');
      } else {
        cell.classList.add(color);
      }

      const tableIndex = indexFromRowCol(r, c) + 1;
      const tRow = tableRows[tableIndex] || [];
      let productId = tRow[2] ? String(tRow[2]) : '';

      const cellIndex0 = indexFromRowCol(r, c);
      if (!productId && products && products[cellIndex0]) {
        productId = products[cellIndex0].id;
        tRow[2] = productId;
        tableRows[tableIndex] = tRow;
      }

      const amount = tRow[3] ? String(tRow[3]) : '';
      const startEpochStr = tRow[4] ? String(tRow[4]) : '';
      const startEpoch = startEpochStr && !isNaN(Number(startEpochStr)) ? Number(startEpochStr) : null;

      if (productId) {
        cell.dataset.productId = productId;
        cell.classList.add(productId);
      } else {
        cell.dataset.productId = '';
      }

      if (amount) {
        cell.classList.add('amount_' + amount);
      }
      if (startEpoch !== null) {
        cell.classList.add('start_time_' + startEpochStr);
        cell.dataset.startEpoch = startEpochStr;
      }

      const location = document.createElement('div');
      location.classList.add('location');
      const productDisplay = productId ? formatProductDisplay(productId) : '';
      location.textContent = productDisplay;

      const meta = document.createElement('div');
      meta.classList.add('cell-meta');

      const productDiv = document.createElement('div');
      productDiv.classList.add('cell-product');
      productDiv.textContent = productDisplay;

      const amountDiv = document.createElement('div');
      amountDiv.classList.add('cell-amount');
      amountDiv.textContent = amount ? 'aantal: ' + amount : '';

      const timeRow = document.createElement('div');
      timeRow.classList.add('cell-time-row');

      const timeDiv = document.createElement('div');
      timeDiv.classList.add('cell-time');
      if (startEpoch !== null) {
        timeDiv.textContent = 'tijd op locatie: ' + computeElapsedLabel(startEpochStr);
      } else {
        timeDiv.textContent = '';
      }

      const clearDiv = document.createElement('div');
      clearDiv.classList.add('cell-clear');
      clearDiv.textContent = 'ðŸ—‘';
      clearDiv.addEventListener('click', function (ev) {
        ev.stopPropagation();
        openWriteoffConfirm(cell);
      });

      timeRow.appendChild(timeDiv);
      timeRow.appendChild(clearDiv);

      const controls = document.createElement('div');
      controls.classList.add('cell-controls');

      const stockInput = document.createElement('input');
      stockInput.type = 'number';
      stockInput.min = '1';
      stockInput.step = '1';
      stockInput.value = amount ? String(amount) : '1';
      stockInput.classList.add('cell-stock-input');
      stockInput.inputMode = 'numeric';
      stockInput.pattern = '[0-9]*';

      const addButton = document.createElement('button');
      addButton.type = 'button';
      addButton.classList.add('cell-add-button');
      addButton.textContent = 'toevoegen';

      addButton.addEventListener('click', function (ev) {
        ev.stopPropagation();
        handleAddStock(cell, stockInput);
      });

      controls.appendChild(stockInput);
      controls.appendChild(addButton);

      meta.appendChild(productDiv);
      meta.appendChild(amountDiv);
      meta.appendChild(timeRow);
      meta.appendChild(controls);

      cell.appendChild(location);
      cell.appendChild(meta);

      return cell;
    }

    function buildGridFromMatrix(matrix) {
      const displayCols = getDisplayCols();

      const groups = new Map();

      for (let r = 1; r <= ROWS; r += 1) {
        for (let c = 1; c <= COLS; c += 1) {
          const tableIndex = indexFromRowCol(r, c) + 1;
          const tRow = tableRows[tableIndex] || [];
          let productId = tRow[2] ? String(tRow[2]) : '';

          const cellIndex0 = indexFromRowCol(r, c);
          if (!productId && products && products[cellIndex0]) {
            productId = products[cellIndex0].id;
            tRow[2] = productId;
            tableRows[tableIndex] = tRow;
          }

          const cat = getProductCategory(productId) || 'leeg';

          if (!groups.has(cat)) {
            groups.set(cat, []);
          }
          groups.get(cat).push({ r: r, c: c });
        }
      }

      const cats = Array.from(groups.keys()).sort(function (a, b) {
        if (a === 'leeg' && b === 'leeg') {
          return 0;
        }
        if (a === 'leeg') {
          return 1;
        }
        if (b === 'leeg') {
          return -1;
        }
        return Number(a) - Number(b);
      });

      grid.innerHTML = '';

      for (let i = 0; i < cats.length; i += 1) {
        const cat = cats[i];

        const title = document.createElement('div');
        title.classList.add('category-title');
        title.textContent = cat === 'leeg' ? 'Leeg / onbekend' : 'Categorie ' + cat;

        const subGrid = document.createElement('div');
        subGrid.classList.add('grid', 'category-grid');
        subGrid.dataset.category = cat;

        const positions = groups.get(cat) || [];
        for (let j = 0; j < positions.length; j += 1) {
          const pos = positions[j];
          subGrid.appendChild(makeCell(pos.r, pos.c, matrix, displayCols));
        }

        grid.appendChild(title);
        grid.appendChild(subGrid);
      }
    }

    function applyMatrixColorsFromCells() {
      const cells = grid.querySelectorAll('.cell');
      let changed = false;
      for (let i = 0; i < cells.length; i += 1) {
        const cell = cells[i];
        const row = Number(cell.dataset.row);
        const col = Number(cell.dataset.col);
        if (row >= 1 && row <= ROWS && col >= 1 && col <= COLS) {
          let found = 'grey';
          for (let j = 0; j < COLOR_CLASSES.length; j += 1) {
            if (cell.classList.contains(COLOR_CLASSES[j])) {
              found = COLOR_CLASSES[j];
              break;
            }
          }
          if (matrix[row - 1][col - 1] !== found) {
            matrix[row - 1][col - 1] = found;
            const idx = indexFromRowCol(row, col) + 1;
            if (tableRows[idx]) {
              tableRows[idx][1] = found;
            }
            changed = true;
          }
        }
      }
      if (changed) {
        scheduleSync();
      }
    }

    function openWriteoffList() {
      writeoffOverlay.classList.add('visible');
      writeoffListPopup.classList.add('visible');
      renderWriteoffList();
      loadWriteoffsIfNeeded();
    }

    function closeWriteoffList() {
      writeoffOverlay.classList.remove('visible');
      writeoffListPopup.classList.remove('visible');
    }

    function openWriteoffConfirm(cell) {
      writeoffTargetCell = cell;
      const row = Number(cell.dataset.row);
      const col = Number(cell.dataset.col);
      const label = locationLabel(row, col);
      const productId = cell.dataset.productId || '';
      const amountMatch = Array.from(cell.classList).find(function (cls) {
        return cls.indexOf('amount_') === 0;
      });
      const amount = amountMatch ? amountMatch.slice(7) : '';
      const startEpoch = cell.dataset.startEpoch || '';
      writeoffLoc.textContent = label;
      writeoffProd.textContent = productId ? formatProductDisplay(productId) : '';
      writeoffAmt.textContent = amount || '';
      writeoffTime.textContent = startEpoch ? computeElapsedLabel(startEpoch) : '';
      writeoffReason.value = '';
      overlay.classList.add('visible');
      writeoffConfirmPopup.classList.add('visible');
    }

    function closeWriteoffConfirm() {
      writeoffTargetCell = null;
      overlay.classList.remove('visible');
      writeoffConfirmPopup.classList.remove('visible');
    }

    function renderWriteoffList() {
      writeoffListBody.innerHTML = '';
      if (!writeoffRows || writeoffRows.length <= 1) {
        const empty = document.createElement('div');
        empty.classList.add('writeoff-list-empty');
        empty.textContent = 'Geen afschrijvingen gevonden.';
        writeoffListBody.appendChild(empty);
        return;
      }

      for (let i = 1; i < writeoffRows.length; i += 1) {
        const row = writeoffRows[i] || [];
        const timestamp = row[0] ? String(row[0]) : '';
        const loc = row[1] ? String(row[1]) : '';
        const prod = row[2] ? String(row[2]) : '';
        const amt = row[3] ? String(row[3]) : '';
        const reason = row[4] ? String(row[4]) : '';

        const item = document.createElement('div');
        item.classList.add('writeoff-item');

        const header = document.createElement('div');
        header.classList.add('writeoff-item-header');

        const title = document.createElement('div');
        title.classList.add('writeoff-item-title');
        title.textContent = loc + ' â€¢ ' + (prod ? formatProductDisplay(prod) : '') + ' â€¢ ' + amt;

        const meta = document.createElement('div');
        meta.classList.add('writeoff-item-meta');
        meta.textContent = timestamp;

        header.appendChild(title);
        header.appendChild(meta);

        const reasonDiv = document.createElement('div');
        reasonDiv.style.fontSize = '0.85rem';
        reasonDiv.style.color = '#333333';
        reasonDiv.textContent = reason;

        item.appendChild(header);
        item.appendChild(reasonDiv);

        writeoffListBody.appendChild(item);
      }
    }

    async function fetchSheetData() {
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'GET'
        });
        if (!response.ok) {
          throw new Error('fetch sheet failed');
        }
        const json = await response.json();
        const rows = parseSheetRows(json);
        const prod = parseProducts(json);
        return { rows: rows, products: prod };
      } catch (err) {
        return null;
      }
    }

    async function fetchWriteoffs() {
      try {
        const response = await fetch(SCRIPT_URL + '?writeoffs=1', {
          method: 'GET'
        });
        if (!response.ok) {
          throw new Error('fetch writeoffs failed');
        }
        const json = await response.json();
        if (!json || !json.rows || !Array.isArray(json.rows)) {
          return [];
        }
        return json.rows;
      } catch (err) {
        return [];
      }
    }

    async function syncChanges() {
      pendingSync = false;
      setSyncState('pending', 'syncing...');
      const payload = {
        action: 'update',
        rows: tableRows
      };
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          throw new Error('sync failed');
        }
        await response.json();
        setSyncState('ok', 'synced');
        syncError = '';
      } catch (err) {
        syncError = String(err && err.message ? err.message : err);
        setSyncState('error', 'sync error');
      }
    }

    async function addWriteoffRow(location, productId, amount, reason) {
      const payload = {
        action: 'writeoff',
        location: location,
        productId: productId,
        amount: amount,
        reason: reason
      };
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          throw new Error('writeoff failed');
        }
        await response.json();
        lastWriteoffLoadMs = 0;
        await loadWriteoffsIfNeeded(true);
      } catch (err) {
      }
    }

    function handleAddStock(cell, stockInput) {
      const row = Number(cell.dataset.row);
      const col = Number(cell.dataset.col);
      const idx = indexFromRowCol(row, col) + 1;
      const tRow = tableRows[idx] || [];
      let productId = cell.dataset.productId || '';
      if (!productId) {
        if (tRow[2]) {
          productId = String(tRow[2]);
          cell.dataset.productId = productId;
          cell.classList.add(productId);
        }
      }

      const stockVal = stockInput.value ? Number(stockInput.value) : 1;
      const addQty = stockVal && !isNaN(stockVal) ? Math.max(1, Math.floor(stockVal)) : 1;

      let currentAmount = tRow[3] ? Number(tRow[3]) : 0;
      if (isNaN(currentAmount)) {
        currentAmount = 0;
      }
      const newAmount = currentAmount + addQty;
      tRow[3] = String(newAmount);

      const nowEpoch = Date.now();
      tRow[4] = String(nowEpoch);

      tableRows[idx] = tRow;

      for (let j = 0; j < COLOR_CLASSES.length; j += 1) {
        cell.classList.remove(COLOR_CLASSES[j]);
      }
      cell.classList.add('green');
      matrix[row - 1][col - 1] = 'green';
      tRow[1] = 'green';

      const amountCls = Array.from(cell.classList).find(function (cls) {
        return cls.indexOf('amount_') === 0;
      });
      if (amountCls) {
        cell.classList.remove(amountCls);
      }
      cell.classList.add('amount_' + String(newAmount));

      const startCls = Array.from(cell.classList).find(function (cls) {
        return cls.indexOf('start_time_') === 0;
      });
      if (startCls) {
        cell.classList.remove(startCls);
      }
      cell.classList.add('start_time_' + String(nowEpoch));
      cell.dataset.startEpoch = String(nowEpoch);

      const meta = cell.querySelector('.cell-meta');
      if (meta) {
        const amountDiv = meta.querySelector('.cell-amount');
        if (amountDiv) {
          amountDiv.textContent = 'aantal: ' + String(newAmount);
        }
        const timeDiv = meta.querySelector('.cell-time');
        if (timeDiv) {
          timeDiv.textContent = 'tijd op locatie: ' + computeElapsedLabel(String(nowEpoch));
        }
      }

      scheduleSync();
    }

    function updateElapsedTimes() {
      const cells = grid.querySelectorAll('.cell');
      for (let i = 0; i < cells.length; i += 1) {
        const cell = cells[i];
        const startEpochStr = cell.dataset.startEpoch || '';
        if (!startEpochStr) {
          continue;
        }
        const meta = cell.querySelector('.cell-meta');
        if (!meta) {
          continue;
        }
        const timeDiv = meta.querySelector('.cell-time');
        if (!timeDiv) {
          continue;
        }
        timeDiv.textContent = 'tijd op locatie: ' + computeElapsedLabel(startEpochStr);
      }
    }

    async function loadWriteoffsIfNeeded(force) {
      const now = Date.now();
      if (!force && lastWriteoffLoadMs && now - lastWriteoffLoadMs < 25000) {
        return;
      }
      const rows = await fetchWriteoffs();
      if (rows && rows.length) {
        writeoffRows = rows;
        lastWriteoffLoadMs = now;
        renderWriteoffList();
      }
    }

    async function init() {
      setSyncState('pending', 'loading...');
      const result = await fetchSheetData();
      if (!result) {
        setSyncState('error', 'load error');
        return;
      }
      tableRows = result.rows;
      products = result.products;
      updateMatrixFromRows(tableRows);
      buildGridFromMatrix(matrix);
      setSyncState('ok', 'synced');

      const observer = new MutationObserver(function () {
        applyMatrixColorsFromCells();
      });

      observer.observe(grid, {
        attributes: true,
        attributeFilter: ['class'],
        subtree: true
      });

      window.addEventListener('resize', function () {
        buildGridFromMatrix(matrix);
      });

      setInterval(updateElapsedTimes, 60000);
      updateElapsedTimes();
    }

    writeoffButton.addEventListener('click', function () {
      openWriteoffList();
    });

    writeoffOverlay.addEventListener('click', function () {
      closeWriteoffList();
    });

    writeoffListClose.addEventListener('click', function () {
      closeWriteoffList();
    });

    writeoffListRefresh.addEventListener('click', function () {
      lastWriteoffLoadMs = 0;
      loadWriteoffsIfNeeded(true);
    });

    overlay.addEventListener('click', function () {
      closeWriteoffConfirm();
    });

    writeoffConfirmClose.addEventListener('click', function () {
      closeWriteoffConfirm();
    });

    writeoffCancel.addEventListener('click', function () {
      closeWriteoffConfirm();
    });

    writeoffConfirm.addEventListener('click', async function () {
      if (!writeoffTargetCell) {
        closeWriteoffConfirm();
        return;
      }
      const row = Number(writeoffTargetCell.dataset.row);
      const col = Number(writeoffTargetCell.dataset.col);
      const loc = locationLabel(row, col);
      const productId = writeoffTargetCell.dataset.productId || '';
      const amountMatch = Array.from(writeoffTargetCell.classList).find(function (cls) {
        return cls.indexOf('amount_') === 0;
      });
      const amount = amountMatch ? amountMatch.slice(7) : '';

      const reason = writeoffReason.value ? String(writeoffReason.value) : '';

      const idx = indexFromRowCol(row, col) + 1;
      const tRow = tableRows[idx] || [];
      tRow[3] = '';
      tRow[4] = '';
      tRow[1] = 'grey';
      tableRows[idx] = tRow;

      for (let j = 0; j < COLOR_CLASSES.length; j += 1) {
        writeoffTargetCell.classList.remove(COLOR_CLASSES[j]);
      }
      writeoffTargetCell.classList.add('grey');
      matrix[row - 1][col - 1] = 'grey';

      const amountCls = Array.from(writeoffTargetCell.classList).find(function (cls) {
        return cls.indexOf('amount_') === 0;
      });
      if (amountCls) {
        writeoffTargetCell.classList.remove(amountCls);
      }

      const startCls = Array.from(writeoffTargetCell.classList).find(function (cls) {
        return cls.indexOf('start_time_') === 0;
      });
      if (startCls) {
        writeoffTargetCell.classList.remove(startCls);
      }
      writeoffTargetCell.dataset.startEpoch = '';

      const meta = writeoffTargetCell.querySelector('.cell-meta');
      if (meta) {
        const amountDiv = meta.querySelector('.cell-amount');
        if (amountDiv) {
          amountDiv.textContent = '';
        }
        const timeDiv = meta.querySelector('.cell-time');
        if (timeDiv) {
          timeDiv.textContent = '';
        }
      }

      closeWriteoffConfirm();
      scheduleSync();
      await addWriteoffRow(loc, productId, amount, reason);
    });

    init();
  </script>
</body>
</html>
